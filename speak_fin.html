<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speak & Fix</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .animate-pulse-record {
            animation: pulse-record 1.5s infinite;
        }
        @keyframes pulse-record {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-6xl mx-auto p-8 lg:p-12 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- C·ªôt 1: Nh·∫≠p v√† qu·∫£n l√Ω t·ª´ v·ª±ng -->
        <div class="lg:col-span-1 flex flex-col space-y-6">
            <h1 class="text-3xl font-bold text-gray-800">Speak & Fix</h1>
            <p class="text-gray-600">
                Nh·∫≠p danh s√°ch t·ª´ ti·∫øng Anh (m·ªói t·ª´ c√°ch nhau b·∫±ng d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng).
            </p>
            <textarea id="word-input" class="w-full p-4 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" rows="5" placeholder="Nh·∫≠p t·ª´ c·ªßa b·∫°n... (v√≠ d·ª•: hello, world, apple, orange)"></textarea>
            <button id="add-words-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Th√™m t·ª´</button>

            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">Danh s√°ch t·ª´</h2>
                <div id="word-list" class="flex flex-wrap gap-2 scroll-container p-2 border border-gray-200 rounded-2xl bg-gray-50">
                    <!-- T·ª´ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <!-- C·ªôt 2: Luy·ªán ph√°t √¢m & K·∫øt qu·∫£ -->
        <div class="lg:col-span-2 flex flex-col space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Luy·ªán ph√°t √¢m</h2>

            <div class="bg-blue-50 p-6 rounded-2xl shadow-inner flex flex-col items-center justify-center space-y-4">
                <p id="selected-word-display" class="text-4xl font-extrabold text-blue-800">
                    Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </p>
                <div class="flex space-x-4">
                    <button id="speak-btn" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Nghe ph√°t √¢m m·∫´u (ph√≠m t·∫Øt: Enter)">
                        <span class="text-xl">üîä</span> Nghe m·∫´u
                    </button>
                    <button id="record-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Luy·ªán n√≥i (ph√≠m t·∫Øt: Space)">
                        <span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i
                    </button>
                </div>
            </div>

            <div id="results-area" class="bg-white p-6 rounded-2xl shadow-inner space-y-4 hidden">
                <h3 class="text-2xl font-bold text-gray-800">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
                <div class="flex items-center justify-between">
                    <p class="text-lg text-gray-700">B·∫°n ƒë√£ n√≥i: <span id="user-transcript" class="font-semibold text-blue-600"></span></p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-bold text-gray-800">ƒêi·ªÉm:</span>
                        <div id="score-display" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md"></div>
                    </div>
                </div>
                <div id="feedback-message" class="text-lg text-gray-700 mt-2"></div>
                <div id="pronunciation-tips-result" class="bg-yellow-100 p-4 rounded-xl text-gray-800 hidden">
                    <p class="font-semibold">M·∫πo c·∫£i thi·ªán ph√°t √¢m:</p>
                    <p id="gemini-tips-content"></p>
                </div>
            </div>
            
            <div id="loading-area" class="bg-gray-200 p-6 rounded-2xl shadow-inner text-center hidden">
                <p class="text-gray-600">ƒêang ph√¢n t√≠ch ph√°t √¢m c·ªßa b·∫°n...</p>
                <div class="mt-4 w-full h-2 bg-gray-300 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 animate-pulse w-full"></div>
                </div>
            </div>
            
        </div>

        <!-- C·ªôt 3: G·ª£i √Ω h·ªçc t·∫≠p & M·∫πo -->
        <div class="lg:col-span-3 flex flex-col space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">G·ª£i √Ω h·ªçc t·∫≠p</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="example-sentence-btn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span class="text-xl">üìö</span> V√≠ d·ª• trong c√¢u
                </button>
                <button id="pronunciation-tips-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span class="text-xl">üìò</span> Xem IPA v√† m·∫πo chung
                </button>
            </div>
        </div>
    </div>

    <!-- Modal cho v√≠ d·ª• trong c√¢u v√† IPA -->
    <div id="example-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">V√≠ d·ª• & M·∫πo Ph√°t √¢m</h3>
                <button id="close-example-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <div id="example-content" class="space-y-4 scroll-container">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </div>
        </div>
    </div>

    <!-- Modal cho m·∫πo ph√°t √¢m t·ªïng h·ª£p -->
    <div id="tips-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">M·∫πo Ph√°t √¢m T·ªïng h·ª£p</h3>
                <button id="close-tips-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <div id="tips-content" class="space-y-6 scroll-container">
                <!-- N·ªôi dung m·∫πo ph√°t √¢m s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </div>
        </div>
    </div>

    <!-- Toast message -->
    <div id="toast-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-xl shadow-lg opacity-0 transition-opacity duration-300">
        <!-- Toast message content -->
    </div>

    <script>
        // ============== C√°c bi·∫øn v√† h·∫±ng s·ªë global ==============
        const wordInput = document.getElementById('word-input');
        const addWordsBtn = document.getElementById('add-words-btn');
        const wordList = document.getElementById('word-list');
        const selectedWordDisplay = document.getElementById('selected-word-display');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const resultsArea = document.getElementById('results-area');
        const userTranscriptSpan = document.getElementById('user-transcript');
        const scoreDisplay = document.getElementById('score-display');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const pronunciationTipsResultDiv = document.getElementById('pronunciation-tips-result');
        const geminiTipsContentDiv = document.getElementById('gemini-tips-content');
        const loadingArea = document.getElementById('loading-area');

        const exampleSentenceBtn = document.getElementById('example-sentence-btn');
        const pronunciationTipsBtn = document.getElementById('pronunciation-tips-btn');
        
        const exampleModal = document.getElementById('example-modal');
        const closeExampleModalBtn = document.getElementById('close-example-modal');
        const exampleContentDiv = document.getElementById('example-content');

        const tipsModal = document.getElementById('tips-modal');
        const closeTipsModalBtn = document.getElementById('close-tips-modal');
        const tipsContentDiv = document.getElementById('tips-content');
        const toastMessageDiv = document.getElementById('toast-message');

        let selectedWord = '';
        let wordDataset = [];
        let isRecording = false;

        // Ki·ªÉm tra h·ªó tr·ª£ Web Speech API
        const isSpeechSynthesisSupported = 'speechSynthesis' in window;
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window;

        // API Speech Recognition
        let recognition = null;
        if (isSpeechRecognitionSupported) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        }

        // M·∫πo ph√°t √¢m cho c√°c √¢m kh√≥
        const PRONUNCIATION_TIPS = {
            'Œ∏': {
                name: '√¢m /Œ∏/ (th trong "think")',
                tip: 'ƒê·∫∑t ƒë·∫ßu l∆∞·ª°i gi·ªØa hai h√†m rƒÉng v√† ƒë·∫©y kh√¥ng kh√≠ ra ngo√†i. ƒê√¢y l√† m·ªôt √¢m v√¥ thanh, kh√¥ng l√†m rung d√¢y thanh qu·∫£n.',
                example: 'think, thank, three, theory'
            },
            '√∞': {
                name: '√¢m /√∞/ (th trong "the")',
                tip: 'Gi·ªëng nh∆∞ /Œ∏/, ƒë·∫∑t ƒë·∫ßu l∆∞·ª°i gi·ªØa hai h√†m rƒÉng nh∆∞ng ƒë·ªìng th·ªùi l√†m rung d√¢y thanh qu·∫£n ƒë·ªÉ t·∫°o ra √¢m h·ªØu thanh.',
                example: 'the, this, that, weather'
            },
            'r': {
                name: '√¢m /r/',
                tip: 'Cu·ªôn l∆∞·ª°i ra ph√≠a sau, kh√¥ng ch·∫°m v√≤m mi·ªáng. M√¥i h∆°i tr√≤n. Tr√°nh cu·ªôn l∆∞·ª°i gi·ªëng nh∆∞ trong ti·∫øng Vi·ªát.',
                example: 'run, red, really, world'
            },
            'l': {
                name: '√¢m /l/',
                tip: 'ƒê·∫∑t ƒë·∫ßu l∆∞·ª°i v√†o sau rƒÉng c·ª≠a tr√™n. C√≥ hai lo·∫°i: "light l" (ƒë·∫ßu t·ª´) v√† "dark l" (cu·ªëi t·ª´). C·ªë g·∫Øng gi·ªØ √¢m r√µ r√†ng.',
                example: 'light, little, really, feel'
            },
            '√¶': {
                name: '√¢m /√¶/ (a trong "apple")',
                tip: 'M·ªü mi·ªáng r·ªông, h·∫° c·∫±m xu·ªëng th·∫•p. ƒê√¢y l√† √¢m gi·ªØa "a" v√† "e" trong ti·∫øng Vi·ªát. V√≠ d·ª•: "c·∫Øn t√°o" ƒë·ªÉ c·∫£m nh·∫≠n.',
                example: 'apple, cat, hat, black'
            }
        };

        // ============== Logic ·ª©ng d·ª•ng ==============

        // H√†m hi·ªÉn th·ªã Toast message
        function showToast(message, duration = 3000) {
            toastMessageDiv.textContent = message;
            toastMessageDiv.classList.remove('opacity-0', 'hidden');
            toastMessageDiv.classList.add('opacity-100');
            setTimeout(() => {
                toastMessageDiv.classList.remove('opacity-100');
                toastMessageDiv.classList.add('opacity-0');
            }, duration);
            setTimeout(() => {
                if (toastMessageDiv.classList.contains('opacity-0')) {
                    toastMessageDiv.classList.add('hidden');
                }
            }, duration + 300);
        }

        // H√†m l∆∞u danh s√°ch t·ª´ v√†o localStorage
        function saveWordsToLocalStorage() {
            localStorage.setItem('speak-and-fix-words', JSON.stringify(wordDataset));
        }

        // H√†m t·∫£i danh s√°ch t·ª´ t·ª´ localStorage
        function loadWordsFromLocalStorage() {
            const storedWords = localStorage.getItem('speak-and-fix-words');
            if (storedWords) {
                wordDataset = JSON.parse(storedWords);
                renderWordList();
            }
        }

        // H√†m render danh s√°ch t·ª´
        function renderWordList() {
            wordList.innerHTML = '';
            wordDataset.forEach((word, index) => {
                const wordChip = document.createElement('div');
                wordChip.className = `flex items-center space-x-2 bg-blue-200 text-blue-800 text-sm font-semibold px-3 py-2 rounded-full cursor-pointer hover:bg-blue-300 transition-colors ${selectedWord === word ? 'ring-2 ring-blue-500' : ''}`;
                wordChip.textContent = word;
                wordChip.dataset.word = word;
                wordChip.onclick = () => selectWord(word);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-blue-800 hover:text-blue-900 leading-none';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeWord(index);
                };
                wordChip.appendChild(removeBtn);
                wordList.appendChild(wordChip);
            });
            updateButtonsState();
        }

        // H√†m ch·ªçn t·ª´
        function selectWord(word) {
            selectedWord = word;
            selectedWordDisplay.textContent = word;
            resultsArea.classList.add('hidden');
            renderWordList(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√£ ch·ªçn
            updateButtonsState();
        }

        // H√†m x√≥a t·ª´
        function removeWord(index) {
            const wordToRemove = wordDataset[index];
            wordDataset.splice(index, 1);
            if (selectedWord === wordToRemove) {
                selectedWord = '';
                selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                resultsArea.classList.add('hidden');
            }
            saveWordsToLocalStorage();
            renderWordList();
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t
        function updateButtonsState() {
            const isWordSelected = selectedWord.length > 0;
            speakBtn.disabled = !isWordSelected || !isSpeechSynthesisSupported || isRecording;
            recordBtn.disabled = !isWordSelected || !isSpeechRecognitionSupported;
            exampleSentenceBtn.disabled = !isWordSelected || isRecording;
            pronunciationTipsBtn.disabled = isRecording;
        }

        // H√†m g·ªçi API Gemini ƒë·ªÉ ph√¢n t√≠ch ph√°t √¢m
        async function analyzePronunciationWithGemini(targetWord, spokenText) {
            loadingArea.classList.remove('hidden');
            resultsArea.classList.add('hidden');

            const prompt = `B·∫°n l√† m·ªôt gia s∆∞ ph√°t √¢m ti·∫øng Anh. Ph√¢n t√≠ch ph√°t √¢m c·ªßa m·ªôt ng∆∞·ªùi h·ªçc. T·ª´ m·ª•c ti√™u l√† '${targetWord}'. Ng∆∞·ªùi h·ªçc ƒë√£ n√≥i l√† '${spokenText}'. Vui l√≤ng cung c·∫•p ph·∫£n h·ªìi d∆∞·ªõi d·∫°ng JSON v·ªõi c√°c tr∆∞·ªùng sau:
                1. 'score': M·ªôt ƒëi·ªÉm s·ªë t·ª´ 1 ƒë·∫øn 100, d·ª±a tr√™n s·ª± ch√≠nh x√°c c·ªßa ph√°t √¢m.
                2. 'feedback': M·ªôt chu·ªói vƒÉn b·∫£n chi ti·∫øt gi·∫£i th√≠ch nh·ªØng l·ªói ph√°t √¢m c·ª• th·ªÉ (v√≠ d·ª•: 'thi·∫øu √¢m cu·ªëi', 'nh·∫ßm l·∫´n gi·ªØa /Œ∏/ v√† /√∞/').
                3. 'ipa': Chu·ªói IPA c·ªßa t·ª´ m·ª•c ti√™u.
                4. 'exampleSentence': M·ªôt c√¢u v√≠ d·ª• s·ª≠ d·ª•ng t·ª´ m·ª•c ti√™u.
                5. 'pronunciationTips': M·ªôt chu·ªói vƒÉn b·∫£n ƒë∆∞a ra m·∫πo c·∫£i thi·ªán ph√°t √¢m.
                ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë·ªÅu c√≥ gi√° tr·ªã.`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            score: { type: "NUMBER" },
                            feedback: { type: "STRING" },
                            ipa: { type: "STRING" },
                            exampleSentence: { type: "STRING" },
                            pronunciationTips: { type: "STRING" }
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const jsonString = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonString);
                updateUIWithGeminiResults(parsedJson, spokenText);
            } catch (error) {
                console.error('L·ªói khi g·ªçi API Gemini:', error);
                showToast("ƒê√£ x·∫£y ra l·ªói khi ph√¢n t√≠ch. Vui l√≤ng th·ª≠ l·∫°i.", 5000);
            } finally {
                loadingArea.classList.add('hidden');
            }
        }
        
        // H√†m c·∫≠p nh·∫≠t UI v·ªõi k·∫øt qu·∫£ t·ª´ Gemini
        function updateUIWithGeminiResults(data, spokenText) {
            const { score, feedback, ipa, exampleSentence, pronunciationTips } = data;

            userTranscriptSpan.textContent = spokenText;
            scoreDisplay.textContent = score;

            let color = 'bg-gray-400';
            if (score >= 85) {
                color = 'bg-green-500';
                feedbackMessageDiv.innerHTML = `Ph√°t √¢m r·∫•t t·ªët! ${feedback}`;
            } else if (score >= 70) {
                color = 'bg-yellow-500';
                feedbackMessageDiv.innerHTML = `Kh√° t·ªët. ${feedback}`;
            } else {
                color = 'bg-red-500';
                feedbackMessageDiv.innerHTML = `C·∫ßn luy·ªán th√™m. ${feedback}`;
            }
            scoreDisplay.className = `w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md ${color}`;

            if (pronunciationTips) {
                geminiTipsContentDiv.textContent = pronunciationTips;
                pronunciationTipsResultDiv.classList.remove('hidden');
            } else {
                pronunciationTipsResultDiv.classList.add('hidden');
            }

            // C·∫≠p nh·∫≠t modal v√≠ d·ª• v√† m·∫πo
            exampleContentDiv.innerHTML = `
                <p class="text-xl font-bold">Phi√™n √¢m IPA:</p>
                <p class="text-3xl font-light text-blue-600">${ipa}</p>
                <div class="mt-4">
                    <p class="text-xl font-bold">V√≠ d·ª• trong c√¢u:</p>
                    <p class="text-gray-700 mt-2">${exampleSentence}</p>
                </div>
            `;
            
            resultsArea.classList.remove('hidden');
        }

        // ================== Event Listeners ==================

        // N√∫t th√™m t·ª´
        addWordsBtn.addEventListener('click', () => {
            const inputWords = wordInput.value.split(/[,\n]/).map(word => word.trim().toLowerCase()).filter(word => word.length > 0);
            wordDataset = [...new Set([...wordDataset, ...inputWords])]; // Lo·∫°i b·ªè t·ª´ tr√πng l·∫∑p
            saveWordsToLocalStorage();
            renderWordList();
            wordInput.value = '';
        });

        // N√∫t nghe m·∫´u
        speakBtn.addEventListener('click', () => {
            if (isSpeechSynthesisSupported && !isRecording) {
                const utterance = new SpeechSynthesisUtterance(selectedWord);
                utterance.lang = 'en-US';
                speechSynthesis.speak(utterance);
                showToast(`ƒêang ph√°t √¢m t·ª´: ${selectedWord}`);
            }
        });

        // N√∫t luy·ªán n√≥i
        recordBtn.addEventListener('click', () => {
            if (recognition) {
                if (isRecording) {
                    recognition.stop();
                    recordBtn.innerHTML = '<span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i';
                    recordBtn.classList.remove('bg-red-700', 'animate-pulse-record');
                    recordBtn.classList.add('bg-red-500');
                    isRecording = false;
                    updateButtonsState();
                } else {
                    try {
                        recognition.start();
                        recordBtn.innerHTML = '<span class="text-xl">üõë</span> D·ª´ng n√≥i';
                        recordBtn.classList.remove('bg-red-500');
                        recordBtn.classList.add('bg-red-700', 'animate-pulse-record');
                        isRecording = true;
                        updateButtonsState();
                        showToast("ƒêang l·∫Øng nghe...");
                    } catch (e) {
                        console.error(e);
                        showToast("L·ªói khi ghi √¢m. H√£y ki·ªÉm tra l·∫°i quy·ªÅn truy c·∫≠p micro.", 5000);
                        isRecording = false;
                        updateButtonsState();
                    }
                }
            }
        });

        // S·ª± ki·ªán khi nh·∫≠n d·∫°ng gi·ªçng n√≥i k·∫øt th√∫c
        if (recognition) {
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                analyzePronunciationWithGemini(selectedWord, transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                showToast(`L·ªói: ${event.error}`, 5000);
            };

            recognition.onend = () => {
                isRecording = false;
                recordBtn.innerHTML = '<span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i';
                recordBtn.classList.remove('bg-red-700', 'animate-pulse-record');
                recordBtn.classList.add('bg-red-500');
                updateButtonsState();
            };
        }

        // N√∫t v√≠ d·ª• trong c√¢u
        exampleSentenceBtn.addEventListener('click', () => {
            if (selectedWord.length > 0) {
                 analyzePronunciationWithGemini(selectedWord, selectedWord); // S·ª≠ d·ª•ng t·ª´ m·ª•c ti√™u ƒë·ªÉ l·∫•y v√≠ d·ª•
                 exampleModal.classList.remove('hidden');
            }
        });

        closeExampleModalBtn.addEventListener('click', () => {
            exampleModal.classList.add('hidden');
        });

        // N√∫t m·∫πo ph√°t √¢m t·ªïng h·ª£p
        pronunciationTipsBtn.addEventListener('click', () => {
            tipsContentDiv.innerHTML = '';
            for (const key in PRONUNCIATION_TIPS) {
                const tip = PRONUNCIATION_TIPS[key];
                const section = document.createElement('div');
                section.className = 'border-b last:border-b-0 pb-4 mb-4';
                section.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-700">C√°ch ph√°t √¢m ${tip.name}</h4>
                    <p class="mt-2 text-gray-600">${tip.tip}</p>
                    <p class="mt-2 font-medium text-gray-700">V√≠ d·ª•: <span class="font-normal">${tip.example}</span></p>
                `;
                tipsContentDiv.appendChild(section);
            }
            tipsModal.classList.remove('hidden');
        });
        
        closeTipsModalBtn.addEventListener('click', () => {
            tipsModal.classList.add('hidden');
        });
        
        // X·ª≠ l√Ω ph√≠m t·∫Øt
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !recordBtn.disabled) {
                e.preventDefault();
                recordBtn.click();
            } else if (e.code === 'Enter' && !speakBtn.disabled && !e.target.isEqualNode(wordInput)) {
                e.preventDefault();
                speakBtn.click();
            }
        });

        // Ki·ªÉm tra h·ªó tr·ª£ API khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', () => {
            loadWordsFromLocalStorage();

            if (!isSpeechSynthesisSupported || !isSpeechRecognitionSupported) {
                 // Kh√¥ng hi·ªÉn th·ªã c·∫£nh b√°o, thay v√†o ƒë√≥ ch·ªâ v√¥ hi·ªáu h√≥a n√∫t
                 speakBtn.disabled = true;
                 recordBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
