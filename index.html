<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speak & Fix</title>
    <!-- Tailwind CSS CDN ƒë·ªÉ t·∫°o giao di·ªán responsive v√† t·ªëi gi·∫£n -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-6xl mx-auto p-8 lg:p-12 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- C·ªôt 1: Nh·∫≠p v√† qu·∫£n l√Ω t·ª´ v·ª±ng -->
        <div class="lg:col-span-1 flex flex-col space-y-6">
            <h1 class="text-3xl font-bold text-gray-800">Speak & Fix</h1>
            <p class="text-gray-600">
                Nh·∫≠p danh s√°ch t·ª´ ti·∫øng Anh (m·ªói t·ª´ c√°ch nhau b·∫±ng d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng).
            </p>
            <textarea id="word-input" class="w-full p-4 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" rows="5" placeholder="Nh·∫≠p t·ª´ c·ªßa b·∫°n... (v√≠ d·ª•: hello, world, apple, orange)"></textarea>
            <button id="add-words-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Th√™m t·ª´</button>

            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">Danh s√°ch t·ª´</h2>
                <div id="word-list" class="flex flex-wrap gap-2 scroll-container p-2 border border-gray-200 rounded-2xl bg-gray-50">
                    <!-- T·ª´ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <!-- C·ªôt 2: Luy·ªán ph√°t √¢m & K·∫øt qu·∫£ -->
        <div class="lg:col-span-2 flex flex-col space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Luy·ªán ph√°t √¢m</h2>

            <div class="bg-blue-50 p-6 rounded-2xl shadow-inner flex flex-col items-center justify-center space-y-4">
                <p id="selected-word-display" class="text-4xl font-extrabold text-blue-800">
                    Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </p>
                <div class="flex space-x-4">
                    <button id="speak-btn" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Nghe ph√°t √¢m m·∫´u (ph√≠m t·∫Øt: Enter)">
                        <span class="text-xl">üîä</span> Nghe m·∫´u
                    </button>
                    <button id="record-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Luy·ªán n√≥i (ph√≠m t·∫Øt: Space)">
                        <span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i
                    </button>
                </div>
            </div>

            <div id="results-area" class="bg-white p-6 rounded-2xl shadow-inner space-y-4 hidden">
                <h3 class="text-2xl font-bold text-gray-800">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
                <div class="flex items-center justify-between">
                    <p class="text-lg text-gray-700">B·∫°n ƒë√£ n√≥i: <span id="user-transcript" class="font-semibold text-blue-600"></span></p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-bold text-gray-800">ƒêi·ªÉm:</span>
                        <div id="score-display" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md"></div>
                    </div>
                </div>
                <div id="feedback-message" class="text-lg text-gray-700 mt-2"></div>
                <div id="pronunciation-tips-result" class="bg-yellow-100 p-4 rounded-xl text-gray-800 hidden">
                    <p class="font-semibold">C·∫ßn ch√∫ √Ω:</p>
                    <ul id="error-sounds-list" class="list-disc list-inside"></ul>
                </div>
            </div>

            <div id="api-unsupported-warning" class="bg-red-100 p-4 rounded-2xl text-red-700 hidden" role="alert">
                <p class="font-bold">C·∫£nh b√°o!</p>
                <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API. T√≠nh nƒÉng nghe m·∫´u v√† luy·ªán n√≥i s·∫Ω b·ªã h·∫°n ch·∫ø ho·∫∑c kh√¥ng ho·∫°t ƒë·ªông.</p>
            </div>
        </div>

        <!-- C·ªôt 3: G·ª£i √Ω h·ªçc t·∫≠p & M·∫πo -->
        <div class="lg:col-span-3 flex flex-col space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">G·ª£i √Ω h·ªçc t·∫≠p</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="pronunciation-tips-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span class="text-xl">üìò</span> M·∫πo ph√°t √¢m
                </button>
                <button id="example-sentence-btn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-cyan-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span class="text-xl">üìö</span> V√≠ d·ª• trong c√¢u
                </button>
            </div>
        </div>

        <!-- D√≤ng ghi c√¥ng m·ªõi -->
        <div class="lg:col-span-3">
            <p class="text-sm text-center text-gray-500 mt-8">Created by th·∫ßy Hi·∫øu</p>
        </div>

    </div>

    <!-- Modal cho m·∫πo ph√°t √¢m & v√≠ d·ª• -->
    <div id="tips-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800">M·∫πo ph√°t √¢m</h3>
                <button id="close-tips-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <div id="tips-content" class="space-y-6 scroll-container">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </div>
        </div>
    </div>

    <!-- Toast message -->
    <div id="toast-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-xl shadow-lg opacity-0 transition-opacity duration-300">
        <!-- Toast message content -->
    </div>

    <script>
        // ============== C√°c bi·∫øn v√† h·∫±ng s·ªë global ==============
        const wordInput = document.getElementById('word-input');
        const addWordsBtn = document.getElementById('add-words-btn');
        const wordList = document.getElementById('word-list');
        const selectedWordDisplay = document.getElementById('selected-word-display');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const resultsArea = document.getElementById('results-area');
        const userTranscriptSpan = document.getElementById('user-transcript');
        const scoreDisplay = document.getElementById('score-display');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const pronunciationTipsResultDiv = document.getElementById('pronunciation-tips-result');
        const errorSoundsList = document.getElementById('error-sounds-list');
        const apiUnsupportedWarning = document.getElementById('api-unsupported-warning');
        const pronunciationTipsBtn = document.getElementById('pronunciation-tips-btn');
        const exampleSentenceBtn = document.getElementById('example-sentence-btn');
        const tipsModal = document.getElementById('tips-modal');
        const closeTipsModalBtn = document.getElementById('close-tips-modal');
        const modalTitle = document.getElementById('modal-title');
        const tipsContentDiv = document.getElementById('tips-content');
        const toastMessageDiv = document.getElementById('toast-message');
        const apiKey = ""; // API key cho Gemini

        let selectedWord = '';
        let wordDataset = [];

        // Ki·ªÉm tra h·ªó tr·ª£ Web Speech API
        const isSpeechSynthesisSupported = 'speechSynthesis' in window;
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window;

        // API Speech Recognition
        let recognition = null;
        if (isSpeechRecognitionSupported) {
            // Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng SpeechRecognition
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // X·ª≠ l√Ω s·ª± ki·ªán khi b·∫Øt ƒë·∫ßu ghi √¢m
            recognition.onstart = () => {
                showToast("ƒêang l·∫Øng nghe... H√£y n√≥i ngay b√¢y gi·ªù.", 5000);
                recordBtn.textContent = 'ƒêang ghi √¢m...';
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = true;
            };

            // X·ª≠ l√Ω s·ª± ki·ªán khi k·∫øt th√∫c ghi √¢m
            recognition.onend = () => {
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };

            // X·ª≠ l√Ω k·∫øt qu·∫£ nh·∫≠n d·∫°ng
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const result = scorePronunciation(selectedWord, transcript);
                updateResultsUI(transcript, result);
            };

            // X·ª≠ l√Ω l·ªói
            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                let errorMessage = 'ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ghi √¢m.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Vui l√≤ng cho ph√©p truy c·∫≠p micro ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                showToast(errorMessage, 5000);
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };
        }

        // IPA Dictionary cho m·ªôt s·ªë t·ª´ ph·ªï bi·∫øn
        const IPA_DICT = {
            'think': '/Œ∏…™≈ãk/', 'world': '/w…úÀêld/', 'water': '/Ààw…îÀêt…ôr/', 'purple': '/Ààp…úÀêrpl/',
            'really': '/ÀàriÀê…ôli/', 'apple': '/Àà√¶pl/', 'orange': '/Àà…îÀêr…™nd í/', 'hello': '/h…ôÀàlo ä/',
            'beautiful': '/ÀàbjuÀêt…ôfl/', 'thorough': '/ÀàŒ∏…úÀêro ä/', 'schedule': '/Ààsked íuÀêl/',
            'strength': '/stre≈ãŒ∏/', 'clothes': '/klo ä√∞z/', 'rhythm': '/Ààr…™√∞…ôm/',
            'sixth': '/s…™ksŒ∏/', 'rural': '/Ààr ä…ôr…ôl/', 'litter': '/Ààl…™t…ôr/', 'little': '/Ààl…™tl/',
            'thistle': '/ÀàŒ∏…™sl/', 'weather': '/Ààwe√∞…ôr/', 'theory': '/ÀàŒ∏…™…ôri/'
        };

        // M·∫πo ph√°t √¢m cho c√°c √¢m kh√≥
        const PRONUNCIATION_TIPS = {
            'Œ∏': {
                name: '√¢m /Œ∏/ (th trong "think")',
                tip: 'ƒê·∫∑t ƒë·∫ßu l∆∞·ª°i gi·ªØa hai h√†m rƒÉng v√† ƒë·∫©y kh√¥ng kh√≠ ra ngo√†i. ƒê√¢y l√† m·ªôt √¢m v√¥ thanh, kh√¥ng l√†m rung d√¢y thanh qu·∫£n.',
                example: 'think, thank, three, theory'
            },
            '√∞': {
                name: '√¢m /√∞/ (th trong "the")',
                tip: 'Gi·ªëng nh∆∞ /Œ∏/, ƒë·∫∑t ƒë·∫ßu l∆∞·ª°i gi·ªØa hai h√†m rƒÉng nh∆∞ng ƒë·ªìng th·ªùi l√†m rung d√¢y thanh qu·∫£n ƒë·ªÉ t·∫°o ra √¢m h·ªØu thanh.',
                example: 'the, this, that, weather'
            },
            'r': {
                name: '√¢m /r/',
                tip: 'Cu·ªôn l∆∞·ª°i ra ph√≠a sau, kh√¥ng ch·∫°m v√≤m mi·ªáng. M√¥i h∆°i tr√≤n. Tr√°nh cu·ªôn l∆∞·ª°i gi·ªëng nh∆∞ trong ti·∫øng Vi·ªát.',
                example: 'run, red, really, world'
            },
            'l': {
                name: '√¢m /l/',
                tip: 'ƒê·∫∑t ƒë·∫ßu l∆∞·ª°i v√†o sau rƒÉng c·ª≠a tr√™n. C√≥ hai lo·∫°i: "light l" (ƒë·∫ßu t·ª´) v√† "dark l" (cu·ªëi t·ª´). C·ªë g·∫Øng gi·ªØ √¢m r√µ r√†ng.',
                example: 'light, little, really, feel'
            },
            '√¶': {
                name: '√¢m /√¶/ (a trong "apple")',
                tip: 'M·ªü mi·ªáng r·ªông, h·∫° c·∫±m xu·ªëng th·∫•p. ƒê√¢y l√† √¢m gi·ªØa "a" v√† "e" trong ti·∫øng Vi·ªát. V√≠ d·ª•: "c·∫Øn t√°o" ƒë·ªÉ c·∫£m nh·∫≠n.',
                example: 'apple, cat, hat, black'
            },
            '…™ vs iÀê': {
                name: 'ph√¢n bi·ªát /…™/ v√† /iÀê/',
                tip: '/…™/ (trong "sit") l√† √¢m ng·∫Øn, mi·ªáng th·∫£ l·ªèng. /iÀê/ (trong "seat") l√† √¢m d√†i, mi·ªáng cƒÉng ra nh∆∞ c∆∞·ªùi.',
                example: 'sit vs seat, bit vs beat, ship vs sheep'
            },
            ' å vs …ëÀê': {
                name: 'ph√¢n bi·ªát / å/ v√† /…ëÀê/',
                tip: '/ å/ (trong "cup") l√† √¢m ng·∫Øn, h∆°i h∆∞·ªõng v·ªÅ √¢m "ƒÉ" ti·∫øng Vi·ªát. /…ëÀê/ (trong "car") l√† √¢m d√†i, mi·ªáng m·ªü tr√≤n, nh∆∞ "a" k√©o d√†i.',
                example: 'cup vs car, fun vs father, but vs part'
            },
            'v vs w': {
                name: 'ph√¢n bi·ªát /v/ v√† /w/',
                tip: '/v/ (trong "very") d√πng rƒÉng tr√™n ch·∫°m m√¥i d∆∞·ªõi. /w/ (trong "we") m√¥i tr√≤n, gi·ªëng nh∆∞ ƒëang hu√Ωt s√°o.',
                example: 'very vs we, voice vs word'
            },
            'p vs b': {
                name: 'ph√¢n bi·ªát /p/ v√† /b/',
                tip: '/p/ (trong "pin") l√† √¢m v√¥ thanh, kh√¥ng rung. /b/ (trong "bin") l√† √¢m h·ªØu thanh, c√≥ rung d√¢y thanh qu·∫£n.',
                example: 'pin vs bin, pat vs bat, play vs blow'
            }
        };

        // ============== Logic ·ª©ng d·ª•ng ==============

        // H√†m hi·ªÉn th·ªã Toast message
        function showToast(message, duration = 3000) {
            toastMessageDiv.textContent = message;
            toastMessageDiv.classList.remove('opacity-0', 'hidden');
            toastMessageDiv.classList.add('opacity-100');
            setTimeout(() => {
                toastMessageDiv.classList.remove('opacity-100');
                toastMessageDiv.classList.add('opacity-0');
            }, duration);
            setTimeout(() => {
                if (toastMessageDiv.classList.contains('opacity-0')) {
                    toastMessageDiv.classList.add('hidden');
                }
            }, duration + 300);
        }

        // H√†m l∆∞u danh s√°ch t·ª´ v√†o localStorage
        function saveWordsToLocalStorage() {
            localStorage.setItem('speak-and-fix-words', JSON.stringify(wordDataset));
        }

        // H√†m t·∫£i danh s√°ch t·ª´ t·ª´ localStorage
        function loadWordsFromLocalStorage() {
            const storedWords = localStorage.getItem('speak-and-fix-words');
            if (storedWords) {
                try {
                    wordDataset = JSON.parse(storedWords);
                    renderWordList();
                } catch (e) {
                    console.error("Failed to parse words from localStorage:", e);
                    localStorage.removeItem('speak-and-fix-words');
                }
            }
        }

        // H√†m render danh s√°ch t·ª´
        function renderWordList() {
            wordList.innerHTML = '';
            wordDataset.forEach((word, index) => {
                const wordChip = document.createElement('div');
                wordChip.className = `flex items-center space-x-2 bg-blue-200 text-blue-800 text-sm font-semibold px-3 py-2 rounded-full cursor-pointer hover:bg-blue-300 transition-colors ${selectedWord === word ? 'ring-2 ring-blue-500' : ''}`;
                wordChip.textContent = word;
                wordChip.dataset.word = word;
                wordChip.onclick = () => selectWord(word);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-blue-800 hover:text-blue-900 leading-none';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeWord(index);
                };
                wordChip.appendChild(removeBtn);
                wordList.appendChild(wordChip);
            });
            updateButtonsState();
        }

        // H√†m ch·ªçn t·ª´
        function selectWord(word) {
            selectedWord = word;
            selectedWordDisplay.textContent = word;
            resultsArea.classList.add('hidden');
            renderWordList(); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√£ ch·ªçn
            updateButtonsState();
        }

        // H√†m x√≥a t·ª´
        function removeWord(index) {
            const wordToRemove = wordDataset[index];
            wordDataset.splice(index, 1);
            if (selectedWord === wordToRemove) {
                selectedWord = '';
                selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                resultsArea.classList.add('hidden');
            }
            saveWordsToLocalStorage();
            renderWordList();
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t
        function updateButtonsState() {
            const isWordSelected = selectedWord.length > 0;
            speakBtn.disabled = !isWordSelected || !isSpeechSynthesisSupported;
            recordBtn.disabled = !isWordSelected || !isSpeechRecognitionSupported;
            pronunciationTipsBtn.disabled = !isWordSelected;
            exampleSentenceBtn.disabled = !isWordSelected;

            if (!isSpeechRecognitionSupported) {
                apiUnsupportedWarning.classList.remove('hidden');
            }
        }

        // H√†m t√≠nh Levenshtein distance
        function levenshtein(a, b) {
            const an = a.toLowerCase().length;
            const bn = b.toLowerCase().length;
            const matrix = Array.from({ length: an + 1 }, () => Array(bn + 1).fill(0));

            for (let i = 0; i <= an; i++) matrix[i][0] = i;
            for (let j = 0; j <= bn; j++) matrix[0][j] = j;

            for (let i = 1; i <= an; i++) {
                for (let j = 1; j <= bn; j++) {
                    const cost = a.toLowerCase()[i - 1] === b.toLowerCase()[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }
            return matrix[an][bn];
        }

        // H√†m so s√°nh v√† ch·∫•m ƒëi·ªÉm
        function scorePronunciation(targetWord, spokenText) {
            const normalizedTarget = targetWord.toLowerCase().replace(/[^a-z]/g, '');
            const normalizedSpoken = spokenText.toLowerCase().replace(/[^a-z]/g, '');

            // M·ª©c 1: So s√°nh ch√≠nh t·∫£ (Levenshtein)
            const distance = levenshtein(normalizedTarget, normalizedSpoken);
            const maxLength = Math.max(normalizedTarget.length, normalizedSpoken.length);
            let score = maxLength > 0 ? Math.round((1 - distance / maxLength) * 100) : 100;

            // Ki·ªÉm tra c√°c l·ªói ph√°t √¢m c∆° b·∫£n (d·ª±a tr√™n IPA)
            const targetIPA = IPA_DICT[targetWord.toLowerCase()];
            const incorrectSounds = [];
            let ipaFeedback = '';

            if (targetIPA) {
                // Heuristics: Gi·∫£ ƒë·ªãnh m·ªôt s·ªë l·ªói ph·ªï bi·∫øn d·ª±a tr√™n ph√°t √¢m
                const ipaKeys = Object.keys(PRONUNCIATION_TIPS);
                ipaKeys.forEach(sound => {
                    // Ki·ªÉm tra s·ª± hi·ªán di·ªán c·ªßa √¢m trong t·ª´ m·ª•c ti√™u
                    if (targetIPA.includes(sound.replace(' vs iÀê', 'i').replace(' vs …ëÀê', 'a').replace(' vs w', 'w').replace(' vs b', 'b'))) {
                         // ƒê√¢y l√† m·ªôt c√°ch ƒë∆°n gi·∫£n, c·∫ßn logic ph·ª©c t·∫°p h∆°n
                        const regex = new RegExp(sound.replace(' vs iÀê', '|').replace(' vs …ëÀê', '|').replace(' vs w', '|').replace(' vs b', '|'), 'i');
                        if (!regex.test(normalizedSpoken) && !incorrectSounds.includes(sound)) {
                            incorrectSounds.push(sound);
                            score = Math.max(0, score - 5);
                        }
                    }
                });

                // Ki·ªÉm tra tr·ªçng √¢m (gi·∫£ ƒë·ªãnh b·∫±ng c√°ch so s√°nh ƒë·ªô d√†i √¢m ti·∫øt)
                const stressSymbol = 'Àà';
                if (targetIPA.includes(stressSymbol)) {
                    if (normalizedSpoken.length < normalizedTarget.length * 0.8 || normalizedSpoken.length > normalizedTarget.length * 1.2) {
                        score = Math.max(0, score - 5);
                        ipaFeedback = 'C√≥ v·∫ª tr·ªçng √¢m ch∆∞a ƒë√∫ng. H√£y ch√∫ √Ω v√†o √¢m ƒë∆∞·ª£c nh·∫•n trong t·ª´.';
                    }
                }
            }

            return { score, feedback: { incorrectSounds, ipaFeedback } };
        }

        // H√†m c·∫≠p nh·∫≠t giao di·ªán k·∫øt qu·∫£
        function updateResultsUI(transcript, result) {
            resultsArea.classList.remove('hidden');
            userTranscriptSpan.textContent = transcript;

            let message = '';
            let color = '';
            if (result.score >= 85) {
                message = 'Ph√°t √¢m t·ªët! H√£y gi·ªØ nh·ªãp ƒëi·ªáu n√†y.';
                color = 'bg-green-500';
            } else if (result.score >= 70) {
                message = `·ªîn, c·∫ßn r√µ h∆°n √¢m: ${result.feedback.incorrectSounds.length > 0 ? result.feedback.incorrectSounds.map(s => `<b>/${s}/</b>`).join(', ') : '(kh√¥ng c√≥ g·ª£i √Ω)'}.`;
                color = 'bg-yellow-500';
            } else {
                message = `C·∫ßn luy·ªán th√™m. T·∫≠p trung v√†o √¢m: ${result.feedback.incorrectSounds.length > 0 ? result.feedback.incorrectSounds.map(s => `<b>/${s}/</b>`).join(', ') : '(kh√¥ng c√≥ g·ª£i √Ω)'}.`;
                color = 'bg-red-500';
            }

            scoreDisplay.textContent = result.score;
            scoreDisplay.className = `w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md ${color}`;
            feedbackMessageDiv.innerHTML = message + (result.feedback.ipaFeedback ? `<br><i>${result.feedback.ipaFeedback}</i>` : '');

            if (result.feedback.incorrectSounds.length > 0) {
                pronunciationTipsResultDiv.classList.remove('hidden');
                errorSoundsList.innerHTML = '';
                result.feedback.incorrectSounds.forEach(sound => {
                    const tip = PRONUNCIATION_TIPS[sound];
                    const li = document.createElement('li');
                    li.innerHTML = `√Çm <b>/${sound}/</b>: ${tip ? tip.tip : 'ƒêang c·∫≠p nh·∫≠t... '}`;
                    errorSoundsList.appendChild(li);
                });
            } else {
                pronunciationTipsResultDiv.classList.add('hidden');
            }
        }

        // H√†m g·ªçi API Gemini ƒë·ªÉ t·∫°o c√¢u v√≠ d·ª•
        async function generateAndDisplayExampleSentences(word) {
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
            exampleSentenceBtn.textContent = 'ƒêang t·∫°o...';
            exampleSentenceBtn.disabled = true;

            const prompt = `Generate 5 example sentences for the English word "${word}". Each sentence should be on a new line.`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            let retries = 0;
            const maxRetries = 3;
            const delay = 1000;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        const sentences = text.trim().split('\n').filter(s => s.length > 0);
                        
                        // C·∫≠p nh·∫≠t n·ªôi dung modal
                        let contentHtml = `<h4 class="text-xl font-bold mb-4">5 c√¢u v√≠ d·ª• cho t·ª´ "${word}"</h4>`;
                        contentHtml += '<ul class="space-y-4">';
                        sentences.forEach(sentence => {
                            contentHtml += `<li class="bg-gray-100 p-3 rounded-xl shadow-sm text-gray-700">${sentence.trim()}</li>`;
                        });
                        contentHtml += '</ul>';
                        
                        displayModal('V√≠ d·ª• trong c√¢u', contentHtml);
                        break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                    }
                } catch (e) {
                    console.error('API call failed:', e);
                    retries++;
                    if (retries < maxRetries) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, retries)));
                    } else {
                        showToast("Kh√¥ng th·ªÉ t·∫°o v√≠ d·ª•. Vui l√≤ng th·ª≠ l·∫°i sau.", 5000);
                        displayModal('L·ªói', '<p class="text-red-600">Kh√¥ng th·ªÉ t·∫£i v√≠ d·ª•. C√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi m√°y ch·ªß.</p>');
                    }
                }
            }
            
            // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
            exampleSentenceBtn.textContent = 'üìö V√≠ d·ª• trong c√¢u';
            exampleSentenceBtn.disabled = false;
        }

        // H√†m hi·ªÉn th·ªã modal chung
        function displayModal(title, content) {
            modalTitle.textContent = title;
            tipsContentDiv.innerHTML = content;
            tipsModal.classList.remove('hidden');
        }

        // ============== C√°c s·ª± ki·ªán ==============

        // N√∫t Th√™m t·ª´
        addWordsBtn.addEventListener('click', () => {
            const newWords = wordInput.value
                .split(/,|\n/)
                .map(word => word.trim().toLowerCase())
                .filter(word => word.length > 0);
            wordDataset = [...new Set([...wordDataset, ...newWords])]; // Lo·∫°i b·ªè tr√πng l·∫∑p
            wordInput.value = '';
            saveWordsToLocalStorage();
            renderWordList();
        });

        // N√∫t Nghe m·∫´u
        speakBtn.addEventListener('click', () => {
            if (selectedWord && isSpeechSynthesisSupported) {
                const utterance = new SpeechSynthesisUtterance(selectedWord);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // N√∫t Ghi √¢m
        recordBtn.addEventListener('click', () => {
            if (selectedWord && isSpeechRecognitionSupported) {
                try {
                    recognition.start();
                } catch (e) {
                    // B·∫Øt l·ªói n·∫øu ƒë√£ c√≥ phi√™n ghi √¢m ƒëang ch·∫°y
                    console.error("Failed to start speech recognition:", e);
                    showToast("ƒê√£ c√≥ phi√™n ghi √¢m ƒëang ho·∫°t ƒë·ªông ho·∫∑c x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau.", 5000);
                }
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // N√∫t M·∫πo ph√°t √¢m
        pronunciationTipsBtn.addEventListener('click', () => {
            if (selectedWord) {
                const tips = getPronunciationTips(selectedWord);
                displayModal('M·∫πo ph√°t √¢m', tips);
            }
        });

        // N√∫t V√≠ d·ª• trong c√¢u
        exampleSentenceBtn.addEventListener('click', () => {
            if (selectedWord) {
                generateAndDisplayExampleSentences(selectedWord);
            }
        });

        // ƒê√≥ng modal
        closeTipsModalBtn.addEventListener('click', () => {
            tipsModal.classList.add('hidden');
        });

        // H√†m l·∫•y m·∫πo ph√°t √¢m
        function getPronunciationTips(word) {
            const ipa = IPA_DICT[word.toLowerCase()];
            if (!ipa) {
                return '<p>Kh√¥ng t√¨m th·∫•y m·∫πo ph√°t √¢m cho t·ª´ n√†y. Vui l√≤ng ch·ªçn m·ªôt t·ª´ kh√°c.</p>';
            }

            let tipsHtml = `<p>Phi√™n √¢m IPA c·ªßa t·ª´ "${word}" l√†: <b>${ipa}</b></p>`;
            tipsHtml += '<p class="mt-4 font-semibold text-lg">M·∫πo ph√°t √¢m cho c√°c √¢m ch√≠nh:</p>';
            
            // T√¨m v√† th√™m c√°c m·∫πo d·ª±a tr√™n c√°c √¢m trong IPA
            Object.keys(PRONUNCIATION_TIPS).forEach(soundKey => {
                if (ipa.includes(soundKey.replace(' vs iÀê', 'i').replace(' vs …ëÀê', 'a').replace(' vs w', 'w').replace(' vs b', 'b'))) {
                    const tip = PRONUNCIATION_TIPS[soundKey];
                    tipsHtml += `
                        <div class="bg-gray-100 p-4 rounded-xl shadow-sm">
                            <h4 class="font-bold text-gray-700">${tip.name}</h4>
                            <p class="text-sm mt-1">${tip.tip}</p>
                            <p class="text-xs italic mt-2">V√≠ d·ª•: ${tip.example}</p>
                        </div>
                    `;
                }
            });

            return tipsHtml;
        }

        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', () => {
            loadWordsFromLocalStorage();
            updateButtonsState();
        });
    </script>
</body>
</html>
