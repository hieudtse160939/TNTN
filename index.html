<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speak & Fix</title>
    <!-- Tailwind CSS CDN ƒë·ªÉ t·∫°o giao di·ªán responsive v√† t·ªëi gi·∫£n -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .highlight-correct {
            color: #16a34a; /* green-600 */
        }
        .highlight-incorrect {
            color: #dc2626; /* red-600 */
            text-decoration: underline;
            text-decoration-color: #dc2626;
        }
        .highlight-extra {
            color: #fb923c; /* orange-400 */
        }
        .feedback-item {
            list-style: none;
            padding-left: 0;
        }
        .feedback-item li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .feedback-item li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #16a34a;
            font-weight: bold;
        }
        .feedback-item.has-errors li:before {
            content: '‚úñ';
            color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-4xl mx-auto p-8 lg:p-12 flex flex-col space-y-8">

        <!-- Header v√† ch·ª©c nƒÉng nh·∫≠p t·ª´ -->
        <div class="flex flex-col items-center text-center space-y-4">
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/96x96/4B5563/FFFFFF?text=Speak" alt="Logo" class="h-24 w-24 object-contain rounded-full">
                <h1 class="text-3xl font-bold text-gray-800">Speak & Fix</h1>
            </div>
            <p class="text-gray-600 max-w-md">
                Nh·∫≠p t·ª´ ho·∫∑c s·ªë (b·∫±ng s·ªë) b·∫°n mu·ªën luy·ªán ph√°t √¢m, sau ƒë√≥ ch·ªçn t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
            <div class="w-full flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <textarea id="word-input" class="w-full md:w-2/3 p-4 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" rows="2" placeholder="Nh·∫≠p t·ª´ ho·∫∑c s·ªë c·ªßa b·∫°n... (v√≠ d·ª•: hello, 123, world)"></textarea>
                <div class="w-full md:w-1/3 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                    <button id="add-words-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Th√™m t·ª´</button>
                    <button id="clear-all-btn" class="flex-1 bg-gray-400 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-gray-500 transition-all">X√≥a t·∫•t c·∫£</button>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch t·ª´ ƒë√£ nh·∫≠p -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Danh s√°ch t·ª´ ƒë√£ th√™m</h2>
            <div id="word-list" class="flex flex-wrap gap-2 scroll-container p-2 border border-gray-200 rounded-2xl bg-gray-50">
                <!-- T·ª´ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>

        <!-- Khu v·ª±c luy·ªán ph√°t √¢m v√† k·∫øt qu·∫£ -->
        <div class="flex flex-col space-y-6 items-center">
            <div class="bg-blue-50 p-6 rounded-2xl shadow-inner flex flex-col items-center justify-center space-y-4 w-full">
                <p id="selected-word-display" class="text-4xl font-extrabold text-blue-800">
                    Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </p>
                <p id="ipa-display" class="text-xl font-medium text-gray-600 italic hidden"></p>
                <div class="flex space-x-4">
                    <button id="speak-btn" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Nghe ph√°t √¢m m·∫´u (ph√≠m t·∫Øt: Enter)">
                        <span class="text-xl">üîä</span> Nghe m·∫´u
                    </button>
                    <button id="record-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Luy·ªán n√≥i (ph√≠m t·∫Øt: Space)">
                        <span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i
                    </button>
                </div>
            </div>

            <div id="results-area" class="bg-white p-6 rounded-2xl shadow-inner space-y-4 w-full hidden">
                <h3 class="text-2xl font-bold text-gray-800">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                    <p class="text-lg text-gray-700 text-center md:text-left">B·∫°n ƒë√£ n√≥i: <span id="user-transcript" class="font-semibold text-blue-600"></span></p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-bold text-gray-800">ƒêi·ªÉm:</span>
                        <div id="score-display" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md"></div>
                    </div>
                </div>
                <div id="feedback-message" class="text-lg text-gray-700 mt-2 text-center md:text-left"></div>
                <div id="comparison-area" class="mt-4 text-center md:text-left">
                    <p class="text-base text-gray-600">So s√°nh v·ªõi t·ª´ g·ªëc:</p>
                    <p id="comparison-text" class="text-2xl font-bold tracking-wide"></p>
                </div>
                <!-- V√πng ph√¢n t√≠ch chi ti·∫øt m·ªõi -->
                <div id="detailed-feedback-area" class="mt-4">
                    <h4 class="text-xl font-semibold text-gray-800">Ph√¢n t√≠ch chi ti·∫øt</h4>
                    <ul id="feedback-list" class="feedback-item mt-2"></ul>
                </div>
            </div>

            <div id="api-unsupported-warning" class="bg-red-100 p-4 rounded-2xl text-red-700 hidden" role="alert">
                <p class="font-bold">C·∫£nh b√°o!</p>
                <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API. T√≠nh nƒÉng nghe m·∫´u v√† luy·ªán n√≥i s·∫Ω b·ªã h·∫°n ch·∫ø ho·∫∑c kh√¥ng ho·∫°t ƒë·ªông.</p>
            </div>
        </div>

        <!-- D√≤ng ghi c√¥ng -->
        <div class="w-full">
            <p class="text-sm text-center text-gray-500 mt-8">Created by th·∫ßy Hi·∫øu</p>
        </div>

    </div>

    <!-- Toast message -->
    <div id="toast-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-xl shadow-lg opacity-0 transition-opacity duration-300">
        <!-- Toast message content -->
    </div>

    <script>
        // ============== C√°c bi·∫øn v√† h·∫±ng s·ªë global ==============
        const wordInput = document.getElementById('word-input');
        const addWordsBtn = document.getElementById('add-words-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const wordList = document.getElementById('word-list');
        const selectedWordDisplay = document.getElementById('selected-word-display');
        const ipaDisplay = document.getElementById('ipa-display');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const resultsArea = document.getElementById('results-area');
        const userTranscriptSpan = document.getElementById('user-transcript');
        const scoreDisplay = document.getElementById('score-display');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const comparisonTextDiv = document.getElementById('comparison-text');
        const apiUnsupportedWarning = document.getElementById('api-unsupported-warning');
        const feedbackList = document.getElementById('feedback-list');
        
        let selectedWord = '';
        let wordDataset = [];

        // D·ªØ li·ªáu IPA c·ª©ng cho m·ªôt s·ªë t·ª´ ph·ªï bi·∫øn
        const ipaData = {
            'hello': '/h…ôÀàlo ä/',
            'world': '/w…úÀêld/',
            'apple': '/Àà√¶p…ôl/',
            'banana': '/b…ôÀàn√¶n…ô/',
            'beautiful': '/ÀàbjuÀêt…ôf…ôl/',
            'pronunciation': '/pr…ôÀån ånsiÀàe…™ É…ôn/',
            'thank you': '/ÀàŒ∏√¶≈ãk juÀê/',
            'welcome': '/Ààw…õlk…ôm/',
            'walk': '/w…îÀêk/',
            'strength': '/str…õ≈ãŒ∏/'
        };

        // Ki·ªÉm tra h·ªó tr·ª£ Web Speech API
        const isSpeechSynthesisSupported = 'speechSynthesis' in window;
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window;

        // API Speech Recognition
        let recognition = null;
        if (isSpeechRecognitionSupported) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                showToast("ƒêang l·∫Øng nghe... H√£y n√≥i ngay b√¢y gi·ªù.", 5000);
                recordBtn.textContent = 'ƒêang ghi √¢m...';
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = true;
            };

            recognition.onend = () => {
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const convertedTranscript = convertDigitsToWords(transcript);
                const result = scorePronunciation(selectedWord, convertedTranscript);
                const feedback = analyzePronunciation(selectedWord, convertedTranscript);
                updateResultsUI(convertedTranscript, result, feedback);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                let errorMessage = 'ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ghi √¢m.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Vui l√≤ng cho ph√©p truy c·∫≠p micro ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                showToast(errorMessage, 5000);
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };
        }

        // H√†m chuy·ªÉn ƒë·ªïi s·ªë th√†nh ch·ªØ c√°i
        function convertNumberToWords(num) {
            if (num === 0) return 'zero';

            const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

            function convertThreeDigitsToWords(n) {
                if (n === 0) return '';
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                if (n < 100) {
                    const ten = Math.floor(n / 10);
                    const unit = n % 10;
                    return tens[ten] + (unit > 0 ? '-' + units[unit] : '');
                }
                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                let result = units[hundred] + ' hundred';
                if (remainder > 0) {
                    result += ' and ' + convertThreeDigitsToWords(remainder);
                }
                return result;
            }

            let words = '';
            let isNegative = false;
            if (num < 0) {
                isNegative = true;
                num = -num;
            }

            if (num < 1000) {
                words = convertThreeDigitsToWords(num);
            } else if (num < 1000000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                words = convertNumberToWords(thousands) + ' thousand';
                if (remainder > 0) {
                    words += ' ' + convertNumberToWords(remainder);
                }
            } else if (num < 1000000000) {
                const millions = Math.floor(num / 1000000);
                const remainder = num % 1000000;
                words = convertNumberToWords(millions) + ' million';
                if (remainder > 0) {
                    words += ' ' + convertNumberToWords(remainder);
                }
            } else {
                return num.toString();
            }
            
            return (isNegative ? 'negative ' : '') + words.trim();
        }

        function convertDigitsToWords(text) {
            let words = text.split(' ');
            let convertedWords = [];

            words.forEach(word => {
                const num = parseInt(word);
                if (!isNaN(num) && isFinite(word)) {
                    convertedWords.push(convertNumberToWords(num));
                } else {
                    convertedWords.push(word);
                }
            });
            return convertedWords.join(' ');
        }
        
        // ============== Logic ·ª©ng d·ª•ng ==============

        // H√†m hi·ªÉn th·ªã Toast message
        const toastMessageDiv = document.getElementById('toast-message');
        function showToast(message, duration = 3000) {
            toastMessageDiv.textContent = message;
            toastMessageDiv.classList.remove('opacity-0', 'hidden');
            toastMessageDiv.classList.add('opacity-100');
            setTimeout(() => {
                toastMessageDiv.classList.remove('opacity-100');
                toastMessageDiv.classList.add('opacity-0');
            }, duration);
            setTimeout(() => {
                if (toastMessageDiv.classList.contains('opacity-0')) {
                    toastMessageDiv.classList.add('hidden');
                }
            }, duration + 300);
        }

        // H√†m l∆∞u danh s√°ch t·ª´ v√†o localStorage
        function saveWordsToLocalStorage() {
            localStorage.setItem('speak-and-fix-words', JSON.stringify(wordDataset));
        }

        // H√†m t·∫£i danh s√°ch t·ª´ t·ª´ localStorage
        function loadWordsFromLocalStorage() {
            const storedWords = localStorage.getItem('speak-and-fix-words');
            if (storedWords) {
                try {
                    wordDataset = JSON.parse(storedWords);
                    renderWordList();
                } catch (e) {
                    console.error("Failed to parse words from localStorage:", e);
                    localStorage.removeItem('speak-and-fix-words');
                }
            }
        }

        // H√†m render danh s√°ch t·ª´
        function renderWordList() {
            wordList.innerHTML = '';
            wordDataset.forEach((word, index) => {
                const wordChip = document.createElement('div');
                wordChip.className = `flex items-center space-x-2 bg-blue-200 text-blue-800 text-sm font-semibold px-3 py-2 rounded-full cursor-pointer hover:bg-blue-300 transition-colors ${selectedWord === word ? 'ring-2 ring-blue-500' : ''}`;
                wordChip.textContent = word;
                wordChip.dataset.word = word;
                wordChip.onclick = () => selectWord(word);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-blue-800 hover:text-blue-900 leading-none';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeWord(index);
                };
                wordChip.appendChild(removeBtn);
                wordList.appendChild(wordChip);
            });
            updateButtonsState();
        }

        // H√†m ch·ªçn t·ª´
        function selectWord(word) {
            selectedWord = word;
            selectedWordDisplay.textContent = word;
            resultsArea.classList.add('hidden');
            renderWordList();
            updateButtonsState();
            
            // Hi·ªÉn th·ªã IPA
            const ipa = getIPA(word);
            if (ipa) {
                ipaDisplay.textContent = ipa;
                ipaDisplay.classList.remove('hidden');
            } else {
                ipaDisplay.classList.add('hidden');
            }
        }

        // H√†m x√≥a t·ª´
        function removeWord(index) {
            const wordToRemove = wordDataset[index];
            wordDataset.splice(index, 1);
            if (selectedWord === wordToRemove) {
                selectedWord = '';
                selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                ipaDisplay.classList.add('hidden');
                resultsArea.classList.add('hidden');
            }
            saveWordsToLocalStorage();
            renderWordList();
        }

        // H√†m x√≥a t·∫•t c·∫£ c√°c t·ª´
        function clearAllWords() {
            wordDataset = [];
            selectedWord = '';
            saveWordsToLocalStorage();
            renderWordList();
            selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
            ipaDisplay.classList.add('hidden');
            resultsArea.classList.add('hidden');
            showToast("ƒê√£ x√≥a t·∫•t c·∫£ c√°c t·ª´.", 3000);
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t
        function updateButtonsState() {
            const isWordSelected = selectedWord.length > 0;
            speakBtn.disabled = !isWordSelected || !isSpeechSynthesisSupported;
            recordBtn.disabled = !isWordSelected || !isSpeechRecognitionSupported;
            clearAllBtn.disabled = wordDataset.length === 0;

            if (!isSpeechRecognitionSupported) {
                apiUnsupportedWarning.classList.remove('hidden');
            }
        }

        // H√†m l·∫•y IPA t·ª´ dictionary
        function getIPA(word) {
            return ipaData[word.toLowerCase()] || `(Kh√¥ng c√≥ IPA)`;
        }

        // H√†m t√≠nh Levenshtein distance
        function levenshtein(a, b) {
            const an = a.toLowerCase().length;
            const bn = b.toLowerCase().length;
            const matrix = Array.from({ length: an + 1 }, () => Array(bn + 1).fill(0));

            for (let i = 0; i <= an; i++) matrix[i][0] = i;
            for (let j = 0; j <= bn; j++) matrix[0][j] = j;

            for (let i = 1; i <= an; i++) {
                for (let j = 1; j <= bn; j++) {
                    const cost = a.toLowerCase()[i - 1] === b.toLowerCase()[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }
            return matrix[an][bn];
        }

        // H√†m so s√°nh v√† ch·∫•m ƒëi·ªÉm
        function scorePronunciation(targetWord, spokenText) {
            let processedTarget = targetWord;
            if (!isNaN(targetWord) && isFinite(targetWord)) {
                processedTarget = convertDigitsToWords(targetWord);
            }

            const normalizedTarget = processedTarget.toLowerCase().replace(/[^a-z]/g, '');
            const normalizedSpoken = spokenText.toLowerCase().replace(/[^a-z]/g, '');

            const distance = levenshtein(normalizedTarget, normalizedSpoken);
            const maxLength = Math.max(normalizedTarget.length, normalizedSpoken.length);
            let score = maxLength > 0 ? Math.round((1 - distance / maxLength) * 100) : 100;
            
            // Add a slight penalty if the spoken text is a different word entirely
            if (distance > normalizedTarget.length * 0.75) {
                score -= 10;
            }
            score = Math.max(0, score);

            return { score };
        }
        
        // H√†m t·∫°o HTML so s√°nh
        function createComparisonHtml(targetWord, spokenText) {
            const targetWords = targetWord.toLowerCase().split(' ');
            const spokenWords = spokenText.toLowerCase().split(' ');

            let html = '';
            let targetIndex = 0;

            for (let i = 0; i < spokenWords.length; i++) {
                const spoken = spokenWords[i];
                const target = targetWords[targetIndex];

                if (target === undefined) {
                    html += `<span class="highlight-extra">${spoken}</span> `;
                    continue;
                }

                if (spoken === target) {
                    html += `<span class="highlight-correct">${spoken}</span> `;
                    targetIndex++;
                } else {
                    // So s√°nh k√Ω t·ª± ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi chi ti·∫øt
                    let comparisonSpans = '';
                    const minLength = Math.min(spoken.length, target.length);
                    for (let j = 0; j < minLength; j++) {
                        if (spoken[j] === target[j]) {
                            comparisonSpans += `<span class="highlight-correct">${spoken[j]}</span>`;
                        } else {
                            comparisonSpans += `<span class="highlight-incorrect">${spoken[j]}</span>`;
                        }
                    }
                    if (spoken.length > target.length) {
                        comparisonSpans += `<span class="highlight-extra">${spoken.slice(minLength)}</span>`;
                    }
                    html += `${comparisonSpans} `;
                    targetIndex++;
                }
            }

            // G·∫°ch ch√¢n c√°c t·ª´ b·ªã thi·∫øu trong ph·∫ßn n√≥i c·ªßa b·∫°n
            for (let i = targetIndex; i < targetWords.length; i++) {
                html += `<span class="highlight-incorrect">${targetWords[i]}</span> `;
            }

            return html.trim();
        }

        // H√†m ph√¢n t√≠ch chi ti·∫øt ph√°t √¢m
        function analyzePronunciation(targetWord, spokenText) {
            const feedback = [];
            const target = targetWord.toLowerCase();
            const spoken = spokenText.toLowerCase();

            // Ph√¢n t√≠ch c√°c tr∆∞·ªùng h·ª£p ph·ªï bi·∫øn
            if (target.includes('th')) {
                if (!spoken.includes('th') && spoken.includes('t') || spoken.includes('d')) {
                    feedback.push("C·∫ßn ch√∫ √Ω √¢m 'th'. Thay v√¨ ph√°t √¢m nh∆∞ 't' ho·∫∑c 'd', h√£y ƒë·∫©y l∆∞·ª°i ra gi·ªØa hai h√†m rƒÉng.");
                } else if (!spoken.includes('th')) {
                    feedback.push("B·∫°n ƒë√£ b·ªè qua √¢m 'th' trong t·ª´. H√£y th·ª≠ luy·ªán t·∫≠p √¢m n√†y.");
                }
            }
            if (target.includes('l')) {
                if (target.endsWith('l') && spoken.length < target.length) {
                    // This is a simple heuristic for silent L
                    if (target === 'walk' && spoken === 'wok') {
                        feedback.push("Trong t·ª´ 'walk', √¢m 'l' l√† √¢m c√¢m (silent). B·∫°n ƒë√£ ph√°t √¢m ƒë√∫ng.");
                    } else {
                        feedback.push("H√£y ƒë·∫£m b·∫£o b·∫°n ph√°t √¢m √¢m 'l' ·ªü cu·ªëi t·ª´ m·ªôt c√°ch r√µ r√†ng, n·∫øu kh√¥ng ph·∫£i l√† √¢m c√¢m.");
                    }
                }
            }
            
            // So s√°nh t·ª´ng t·ª´ m·ªôt
            const targetWords = targetWord.toLowerCase().split(' ');
            const spokenWords = spokenText.toLowerCase().split(' ');

            for (let i = 0; i < targetWords.length; i++) {
                const targetW = targetWords[i];
                const spokenW = spokenWords[i];
                if (!spokenW) continue;

                if (targetW !== spokenW) {
                    const distance = levenshtein(targetW, spokenW);
                    const maxLength = Math.max(targetW.length, spokenW.length);
                    if (distance / maxLength > 0.5) {
                        feedback.push(`C√≥ v·∫ª b·∫°n ƒë√£ ph√°t √¢m sai t·ª´ "${targetW}". H√£y c·ªë g·∫Øng nghe k·ªπ v√† l·∫∑p l·∫°i.`);
                    }
                }
            }

            if (spokenWords.length > targetWords.length) {
                feedback.push("B·∫°n ƒë√£ th√™m m·ªôt v√†i t·ª´ kh√¥ng c√≥ trong t·ª´ g·ªëc. H√£y ch√∫ √Ω h∆°n ƒë·∫øn nh·ªØng t·ª´ c·∫ßn n√≥i.");
            }
            
            if (feedback.length === 0) {
                feedback.push("Ph√°t √¢m c·ªßa b·∫°n r·∫•t t·ªët! Kh√¥ng c√≥ l·ªói r√µ r√†ng n√†o ƒë∆∞·ª£c ph√°t hi·ªán.");
            }

            return feedback;
        }

        // H√†m c·∫≠p nh·∫≠t giao di·ªán k·∫øt qu·∫£
        function updateResultsUI(transcript, result, feedback) {
            resultsArea.classList.remove('hidden');
            userTranscriptSpan.textContent = transcript;
            feedbackList.innerHTML = '';

            let message = '';
            let color = '';
            if (result.score >= 85) {
                message = 'Ph√°t √¢m t·ªët! C√°c t·ª´ b·∫°n n√≥i kh·ªõp g·∫ßn nh∆∞ ho√†n to√†n.';
                color = 'bg-green-500';
            } else if (result.score >= 70) {
                message = `Ph√°t √¢m t·∫°m ·ªïn. C·∫ßn luy·ªán t·∫≠p th√™m m·ªôt ch√∫t nh√©.`;
                color = 'bg-yellow-500';
            } else {
                message = `C·∫ßn luy·ªán th√™m. C·ªë g·∫Øng ph√°t √¢m r√µ r√†ng h∆°n.`;
                color = 'bg-red-500';
            }

            scoreDisplay.textContent = result.score;
            scoreDisplay.className = `w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md ${color}`;
            feedbackMessageDiv.innerHTML = message;
            
            // C·∫≠p nh·∫≠t so s√°nh
            const comparisonHtml = createComparisonHtml(selectedWord, transcript);
            comparisonTextDiv.innerHTML = comparisonHtml;
            
            // C·∫≠p nh·∫≠t feedback chi ti·∫øt
            let hasErrors = false;
            feedback.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                if (item.includes("C·∫ßn ch√∫ √Ω") || item.includes("b·ªè qua") || item.includes("sai t·ª´") || item.includes("th√™m m·ªôt v√†i t·ª´")) {
                    hasErrors = true;
                }
                feedbackList.appendChild(li);
            });

            if (hasErrors) {
                feedbackList.classList.add('has-errors');
            } else {
                feedbackList.classList.remove('has-errors');
            }
        }

        // ============== C√°c s·ª± ki·ªán ==============

        // N√∫t Th√™m t·ª´
        addWordsBtn.addEventListener('click', () => {
            const newWords = wordInput.value
                .split(/,|\n/)
                .map(word => word.trim().toLowerCase())
                .filter(word => word.length > 0);
            
            if (newWords.length > 0) {
                wordDataset = [...new Set([...wordDataset, ...newWords])];
                wordInput.value = '';
                saveWordsToLocalStorage();
                renderWordList();
            }
        });

        // N√∫t X√≥a t·∫•t c·∫£
        clearAllBtn.addEventListener('click', clearAllWords);

        // N√∫t Nghe m·∫´u
        speakBtn.addEventListener('click', () => {
            if (selectedWord && isSpeechSynthesisSupported) {
                const utterance = new SpeechSynthesisUtterance(selectedWord);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // N√∫t Ghi √¢m
        recordBtn.addEventListener('click', () => {
            if (selectedWord && isSpeechRecognitionSupported) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Failed to start speech recognition:", e);
                    showToast("ƒê√£ c√≥ phi√™n ghi √¢m ƒëang ho·∫°t ƒë·ªông ho·∫∑c x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau.", 5000);
                }
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', () => {
            loadWordsFromLocalStorage();
            updateButtonsState();
        });
    </script>
</body>
</html>
