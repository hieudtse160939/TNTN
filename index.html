<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speak & Fix</title>
    <!-- Tailwind CSS CDN ƒë·ªÉ t·∫°o giao di·ªán responsive v√† t·ªëi gi·∫£n -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-4xl mx-auto p-8 lg:p-12 flex flex-col space-y-8">

        <!-- Header v√† ch·ª©c nƒÉng nh·∫≠p t·ª´ -->
        <div class="flex flex-col items-center text-center space-y-4">
            <div class="flex items-center space-x-4">
                <img src="https://scontent.fsgn16-1.fna.fbcdn.net/v/t39.30808-6/472919267_470131356146451_729434797204896135_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=a5f93a&_nc_eui2=AeE9ZTI6fgF9mTD0MyD7laeXfnuzvqEUccB-e7O-oRRxwDIaS-EDHpQHzBvfP5ea2zg62_N0eEpCNHkyzm5k46eP&_nc_ohc=6lFMDXtlVGwQ7kNvwFZPchX&_nc_oc=Adm9jx2WiHHJP81PAPZ0wg7aKKnUC-_k05rUmZjoJ5COmbps5Pdi4FYqFyQUR9INOmmhn6ZW-uUnq5QV5g3LmVDl&_nc_zt=23&_nc_ht=scontent.fsgn16-1.fna&_nc_gid=ztpM7fRjRnh3-lAg6D4kxg&oh=00_AfW9F3Z9mX7-zY6dElWdyZX_Kyte-6tcHrXIJoFgKsuTnA&oe=68A52689" alt="New Image" class="h-24 w-24 object-contain rounded-full">
                <h1 class="text-3xl font-bold text-gray-800">Speak & Fix</h1>
            </div>
            <p class="text-gray-600 max-w-md">
                Nh·∫≠p t·ª´ ho·∫∑c s·ªë (b·∫±ng s·ªë) b·∫°n mu·ªën luy·ªán ph√°t √¢m, sau ƒë√≥ ch·ªçn t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
            <div class="w-full flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <textarea id="word-input" class="w-full md:w-2/3 p-4 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" rows="2" placeholder="Nh·∫≠p t·ª´ ho·∫∑c s·ªë c·ªßa b·∫°n... (v√≠ d·ª•: hello, 123, world)"></textarea>
                <button id="add-words-btn" class="w-full md:w-1/3 bg-blue-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Th√™m t·ª´</button>
            </div>
        </div>

        <!-- Danh s√°ch t·ª´ ƒë√£ nh·∫≠p -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Danh s√°ch t·ª´ ƒë√£ th√™m</h2>
            <div id="word-list" class="flex flex-wrap gap-2 scroll-container p-2 border border-gray-200 rounded-2xl bg-gray-50">
                <!-- T·ª´ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>

        <!-- Khu v·ª±c luy·ªán ph√°t √¢m v√† k·∫øt qu·∫£ -->
        <div class="flex flex-col space-y-6 items-center">
            <div class="bg-blue-50 p-6 rounded-2xl shadow-inner flex flex-col items-center justify-center space-y-4 w-full">
                <p id="selected-word-display" class="text-4xl font-extrabold text-blue-800">
                    Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </p>
                <div class="flex space-x-4">
                    <button id="speak-btn" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Nghe ph√°t √¢m m·∫´u (ph√≠m t·∫Øt: Enter)">
                        <span class="text-xl">üîä</span> Nghe m·∫´u
                    </button>
                    <button id="record-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Luy·ªán n√≥i (ph√≠m t·∫Øt: Space)">
                        <span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i
                    </button>
                </div>
            </div>

            <div id="results-area" class="bg-white p-6 rounded-2xl shadow-inner space-y-4 w-full hidden">
                <h3 class="text-2xl font-bold text-gray-800">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                    <p class="text-lg text-gray-700 text-center md:text-left">B·∫°n ƒë√£ n√≥i: <span id="user-transcript" class="font-semibold text-blue-600"></span></p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-bold text-gray-800">ƒêi·ªÉm:</span>
                        <div id="score-display" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md"></div>
                    </div>
                </div>
                <div id="feedback-message" class="text-lg text-gray-700 mt-2 text-center md:text-left"></div>
            </div>

            <div id="api-unsupported-warning" class="bg-red-100 p-4 rounded-2xl text-red-700 hidden" role="alert">
                <p class="font-bold">C·∫£nh b√°o!</p>
                <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API. T√≠nh nƒÉng nghe m·∫´u v√† luy·ªán n√≥i s·∫Ω b·ªã h·∫°n ch·∫ø ho·∫∑c kh√¥ng ho·∫°t ƒë·ªông.</p>
            </div>
        </div>

        <!-- D√≤ng ghi c√¥ng -->
        <div class="w-full">
            <p class="text-sm text-center text-gray-500 mt-8">Created by th·∫ßy Hi·∫øu</p>
        </div>

    </div>

    <!-- Toast message -->
    <div id="toast-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-xl shadow-lg opacity-0 transition-opacity duration-300">
        <!-- Toast message content -->
    </div>

    <script>
        // ============== C√°c bi·∫øn v√† h·∫±ng s·ªë global ==============
        const wordInput = document.getElementById('word-input');
        const addWordsBtn = document.getElementById('add-words-btn');
        const wordList = document.getElementById('word-list');
        const selectedWordDisplay = document.getElementById('selected-word-display');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const resultsArea = document.getElementById('results-area');
        const userTranscriptSpan = document.getElementById('user-transcript');
        const scoreDisplay = document.getElementById('score-display');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const apiUnsupportedWarning = document.getElementById('api-unsupported-warning');
        
        let selectedWord = '';
        let wordDataset = [];

        // Ki·ªÉm tra h·ªó tr·ª£ Web Speech API
        const isSpeechSynthesisSupported = 'speechSynthesis' in window;
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window;

        // API Speech Recognition
        let recognition = null;
        if (isSpeechRecognitionSupported) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                showToast("ƒêang l·∫Øng nghe... H√£y n√≥i ngay b√¢y gi·ªù.", 5000);
                recordBtn.textContent = 'ƒêang ghi √¢m...';
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = true;
            };

            recognition.onend = () => {
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const convertedTranscript = convertDigitsToWords(transcript);
                const result = scorePronunciation(selectedWord, convertedTranscript);
                updateResultsUI(convertedTranscript, result);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                let errorMessage = 'ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ghi √¢m.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Vui l√≤ng cho ph√©p truy c·∫≠p micro ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                showToast(errorMessage, 5000);
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };
        }

        // H√†m chuy·ªÉn ƒë·ªïi s·ªë th√†nh ch·ªØ c√°i
        function convertNumberToWords(num) {
            if (num === 0) return 'zero';

            const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

            function convertThreeDigitsToWords(n) {
                if (n === 0) return '';
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                if (n < 100) {
                    const ten = Math.floor(n / 10);
                    const unit = n % 10;
                    return tens[ten] + (unit > 0 ? '-' + units[unit] : '');
                }
                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                let result = units[hundred] + ' hundred';
                if (remainder > 0) {
                    result += ' and ' + convertThreeDigitsToWords(remainder);
                }
                return result;
            }

            let words = '';
            let isNegative = false;
            if (num < 0) {
                isNegative = true;
                num = -num;
            }

            if (num < 1000) {
                words = convertThreeDigitsToWords(num);
            } else if (num < 1000000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                words = convertNumberToWords(thousands) + ' thousand';
                if (remainder > 0) {
                    words += ' ' + convertNumberToWords(remainder);
                }
            } else if (num < 1000000000) {
                const millions = Math.floor(num / 1000000);
                const remainder = num % 1000000;
                words = convertNumberToWords(millions) + ' million';
                if (remainder > 0) {
                    words += ' ' + convertNumberToWords(remainder);
                }
            } else {
                return num.toString();
            }
            
            return (isNegative ? 'negative ' : '') + words.trim();
        }

        function convertDigitsToWords(text) {
            let words = text.split(' ');
            let convertedWords = [];

            words.forEach(word => {
                const num = parseInt(word);
                if (!isNaN(num) && isFinite(word)) {
                    convertedWords.push(convertNumberToWords(num));
                } else {
                    convertedWords.push(word);
                }
            });
            return convertedWords.join(' ');
        }
        
        // ============== Logic ·ª©ng d·ª•ng ==============

        // H√†m hi·ªÉn th·ªã Toast message
        const toastMessageDiv = document.getElementById('toast-message');
        function showToast(message, duration = 3000) {
            toastMessageDiv.textContent = message;
            toastMessageDiv.classList.remove('opacity-0', 'hidden');
            toastMessageDiv.classList.add('opacity-100');
            setTimeout(() => {
                toastMessageDiv.classList.remove('opacity-100');
                toastMessageDiv.classList.add('opacity-0');
            }, duration);
            setTimeout(() => {
                if (toastMessageDiv.classList.contains('opacity-0')) {
                    toastMessageDiv.classList.add('hidden');
                }
            }, duration + 300);
        }

        // H√†m l∆∞u danh s√°ch t·ª´ v√†o localStorage
        function saveWordsToLocalStorage() {
            localStorage.setItem('speak-and-fix-words', JSON.stringify(wordDataset));
        }

        // H√†m t·∫£i danh s√°ch t·ª´ t·ª´ localStorage
        function loadWordsFromLocalStorage() {
            const storedWords = localStorage.getItem('speak-and-fix-words');
            if (storedWords) {
                try {
                    wordDataset = JSON.parse(storedWords);
                    renderWordList();
                } catch (e) {
                    console.error("Failed to parse words from localStorage:", e);
                    localStorage.removeItem('speak-and-fix-words');
                }
            }
        }

        // H√†m render danh s√°ch t·ª´
        function renderWordList() {
            wordList.innerHTML = '';
            wordDataset.forEach((word, index) => {
                const wordChip = document.createElement('div');
                wordChip.className = `flex items-center space-x-2 bg-blue-200 text-blue-800 text-sm font-semibold px-3 py-2 rounded-full cursor-pointer hover:bg-blue-300 transition-colors ${selectedWord === word ? 'ring-2 ring-blue-500' : ''}`;
                wordChip.textContent = word;
                wordChip.dataset.word = word;
                wordChip.onclick = () => selectWord(word);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-blue-800 hover:text-blue-900 leading-none';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeWord(index);
                };
                wordChip.appendChild(removeBtn);
                wordList.appendChild(wordChip);
            });
            updateButtonsState();
        }

        // H√†m ch·ªçn t·ª´
        function selectWord(word) {
            selectedWord = word;
            selectedWordDisplay.textContent = word;
            resultsArea.classList.add('hidden');
            renderWordList();
            updateButtonsState();
        }

        // H√†m x√≥a t·ª´
        function removeWord(index) {
            const wordToRemove = wordDataset[index];
            wordDataset.splice(index, 1);
            if (selectedWord === wordToRemove) {
                selectedWord = '';
                selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                resultsArea.classList.add('hidden');
            }
            saveWordsToLocalStorage();
            renderWordList();
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t
        function updateButtonsState() {
            const isWordSelected = selectedWord.length > 0;
            speakBtn.disabled = !isWordSelected || !isSpeechSynthesisSupported;
            recordBtn.disabled = !isWordSelected || !isSpeechRecognitionSupported;

            if (!isSpeechRecognitionSupported) {
                apiUnsupportedWarning.classList.remove('hidden');
            }
        }

        // H√†m t√≠nh Levenshtein distance
        function levenshtein(a, b) {
            const an = a.toLowerCase().length;
            const bn = b.toLowerCase().length;
            const matrix = Array.from({ length: an + 1 }, () => Array(bn + 1).fill(0));

            for (let i = 0; i <= an; i++) matrix[i][0] = i;
            for (let j = 0; j <= bn; j++) matrix[0][j] = j;

            for (let i = 1; i <= an; i++) {
                for (let j = 1; j <= bn; j++) {
                    const cost = a.toLowerCase()[i - 1] === b.toLowerCase()[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }
            return matrix[an][bn];
        }

        // H√†m so s√°nh v√† ch·∫•m ƒëi·ªÉm
        function scorePronunciation(targetWord, spokenText) {
            let processedTarget = targetWord;
            if (!isNaN(targetWord) && isFinite(targetWord)) {
                processedTarget = convertDigitsToWords(targetWord);
            }

            const normalizedTarget = processedTarget.toLowerCase().replace(/[^a-z]/g, '');
            const normalizedSpoken = spokenText.toLowerCase().replace(/[^a-z]/g, '');

            const distance = levenshtein(normalizedTarget, normalizedSpoken);
            const maxLength = Math.max(normalizedTarget.length, normalizedSpoken.length);
            let score = maxLength > 0 ? Math.round((1 - distance / maxLength) * 100) : 100;

            return { score };
        }

        // H√†m c·∫≠p nh·∫≠t giao di·ªán k·∫øt qu·∫£
        function updateResultsUI(transcript, result) {
            resultsArea.classList.remove('hidden');
            userTranscriptSpan.textContent = transcript;

            let message = '';
            let color = '';
            if (result.score >= 85) {
                message = 'Ph√°t √¢m t·ªët! B·∫°n l√†m r·∫•t t·ªët.';
                color = 'bg-green-500';
            } else if (result.score >= 70) {
                message = `Ph√°t √¢m t·∫°m ·ªïn. C·∫ßn luy·ªán t·∫≠p th√™m m·ªôt ch√∫t nh√©.`;
                color = 'bg-yellow-500';
            } else {
                message = `C·∫ßn luy·ªán th√™m. C·ªë g·∫Øng ph√°t √¢m r√µ r√†ng h∆°n.`;
                color = 'bg-red-500';
            }

            scoreDisplay.textContent = result.score;
            scoreDisplay.className = `w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md ${color}`;
            feedbackMessageDiv.innerHTML = message;
        }

        // ============== C√°c s·ª± ki·ªán ==============

        // N√∫t Th√™m t·ª´
        addWordsBtn.addEventListener('click', () => {
            const newWords = wordInput.value
                .split(/,|\n/)
                .map(word => word.trim().toLowerCase())
                .filter(word => word.length > 0);
            wordDataset = [...new Set([...wordDataset, ...newWords])];
            wordInput.value = '';
            saveWordsToLocalStorage();
            renderWordList();
        });

        // N√∫t Nghe m·∫´u
        speakBtn.addEventListener('click', () => {
            if (selectedWord && isSpeechSynthesisSupported) {
                const utterance = new SpeechSynthesisUtterance(selectedWord);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // N√∫t Ghi √¢m
        recordBtn.addEventListener('click', () => {
            if (selectedWord && isSpeechRecognitionSupported) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Failed to start speech recognition:", e);
                    showToast("ƒê√£ c√≥ phi√™n ghi √¢m ƒëang ho·∫°t ƒë·ªông ho·∫∑c x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau.", 5000);
                }
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', () => {
            loadWordsFromLocalStorage();
            updateButtonsState();
        });
    </script>
</body>
</html>
