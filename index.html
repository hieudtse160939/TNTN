<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speak & Fix</title>
    <!-- Tailwind CSS CDN ƒë·ªÉ t·∫°o giao di·ªán responsive v√† t·ªëi gi·∫£n -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .highlight-correct {
            color: #16a34a; /* green-600 */
        }
        .highlight-incorrect {
            color: #dc2626; /* red-600 */
            text-decoration: underline;
            text-decoration-color: #dc2626;
        }
        .highlight-extra {
            color: #fb923c; /* orange-400 */
        }
        .feedback-item {
            list-style: none;
            padding-left: 0;
        }
        .feedback-item li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .feedback-item li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #16a34a;
            font-weight: bold;
        }
        .feedback-item.has-errors li:before {
            content: '‚úñ';
            position: absolute;
            left: 0;
            color: #dc2626;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-4xl mx-auto p-8 lg:p-12 flex flex-col space-y-8">

        <!-- Header v√† ch·ª©c nƒÉng nh·∫≠p t·ª´ -->
        <div class="flex flex-col items-center text-center space-y-4">
            <div class="flex items-center space-x-4">
                <img src="https://scontent.fsgn16-1.fna.fbcdn.net/v/t39.30808-6/472919267_470131356146451_729434797204896135_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=a5f93a&_nc_eui2=AeE9ZTI6fgF9mTD0MyD7laeXfnuzvqEUccB-e7O-oRRxwDIaS-EDHpQHzBvfP5ea2zg62_N0eEpCNHkyzm5k46eP&_nc_ohc=6lFMDXtlVGwQ7kNvwFZPchX&_nc_oc=Adm9jx2WiHHJP81PAPZ0wg7aKKnUC-_k05rUmZjoJ5COmbps5Pdi4FYqFyQUR9INOmmhn6ZW-uUnq5QV5g3LmVDl&_nc_zt=23&_nc_ht=scontent.fsgn16-1.fna&_nc_gid=uUrz4QgdEyji00woz_SS3Q&oh=00_AfWuZEop9szEaL8m4Lt-wXquoQb_G019_0di47ti-H6zAg&oe=68A52689" alt="Logo" class="h-24 w-24 object-contain rounded-full">
                <h1 class="text-3xl font-bold text-gray-800">Speak & Fix</h1>
            </div>
            <p class="text-gray-600 max-w-md">
                Nh·∫≠p t·ª´ ho·∫∑c s·ªë (b·∫±ng s·ªë) b·∫°n mu·ªën luy·ªán ph√°t √¢m, sau ƒë√≥ ch·ªçn t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
            <div class="w-full flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <textarea id="word-input" class="w-full md:w-2/3 p-4 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" rows="2" placeholder="Nh·∫≠p t·ª´ ho·∫∑c s·ªë c·ªßa b·∫°n... (v√≠ d·ª•: hello, 123, world)"></textarea>
                <div class="w-full md:w-1/3 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                    <button id="add-words-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Th√™m t·ª´</button>
                    <button id="clear-all-btn" class="flex-1 bg-gray-400 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-gray-500 transition-all">X√≥a t·∫•t c·∫£</button>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch t·ª´ ƒë√£ nh·∫≠p -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Danh s√°ch t·ª´ ƒë√£ th√™m</h2>
            <div id="word-list" class="flex flex-wrap gap-2 scroll-container p-2 border border-gray-200 rounded-2xl bg-gray-50">
                <!-- T·ª´ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
            </div>
        </div>
        
        <!-- Khu v·ª±c luy·ªán ph√°t √¢m v√† k·∫øt qu·∫£ -->
        <div class="flex flex-col space-y-6 items-center">
            <div class="bg-blue-50 p-6 rounded-2xl shadow-inner flex flex-col items-center justify-center space-y-4 w-full">
                <p id="selected-word-display" class="text-4xl font-extrabold text-blue-800">
                    Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </p>
                <p id="ipa-display" class="text-xl font-medium text-gray-600 italic hidden"></p>
                <div class="flex space-x-4">
                    <button id="speak-btn" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Nghe ph√°t √¢m m·∫´u (ph√≠m t·∫Øt: Enter)">
                        <span class="text-xl">üîä</span> Nghe m·∫´u
                    </button>
                    <button id="record-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:bg-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Luy·ªán n√≥i (ph√≠m t·∫Øt: Space)">
                        <span class="text-xl">üéôÔ∏è</span> Luy·ªán n√≥i
                    </button>
                </div>
            </div>
            
            <div id="results-area" class="bg-white p-6 rounded-2xl shadow-inner space-y-4 w-full hidden">
                <h3 class="text-2xl font-bold text-gray-800">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                    <p class="text-lg text-gray-700 text-center md:text-left">B·∫°n ƒë√£ n√≥i: <span id="user-transcript" class="font-semibold text-blue-600"></span></p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-bold text-gray-800">ƒêi·ªÉm:</span>
                        <div id="score-display" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md"></div>
                    </div>
                </div>
                <div id="feedback-message" class="text-lg text-gray-700 mt-2 text-center md:text-left"></div>
                <!-- V√πng ph√¢n t√≠ch chi ti·∫øt m·ªõi -->
                <div id="detailed-feedback-area" class="mt-4">
                    <h4 class="text-xl font-semibold text-gray-800">Ph√¢n t√≠ch chi ti·∫øt</h4>
                    <ul id="feedback-list" class="feedback-item mt-2"></ul>
                </div>
            </div>

            <!-- New section for example sentences -->
            <div id="example-sentences-area" class="bg-white p-6 rounded-2xl shadow-inner space-y-4 w-full hidden">
                <h3 class="text-2xl font-bold text-gray-800">C√¢u v√≠ d·ª•</h3>
                <div class="flex items-center space-x-4">
                    <label for="num-sentences" class="text-lg text-gray-700">S·ªë l∆∞·ª£ng c√¢u:</label>
                    <!-- Gi·ªõi h·∫°n s·ªë c√¢u t·ªëi ƒëa l√† 10 -->
                    <input type="number" id="num-sentences" value="3" min="1" max="10" class="w-20 p-2 border border-gray-300 rounded-lg text-center">
                    <button id="generate-sentences-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-2xl shadow-lg hover:bg-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        T·∫°o
                    </button>
                </div>
                <!-- V√πng hi·ªÉn th·ªã c·∫£nh b√°o m·ªõi -->
                <p id="sentence-warning" class="text-red-500 italic text-sm mt-2 hidden">
                    Vui l√≤ng nh·∫≠p m·ªôt s·ªë nh·ªè h∆°n ho·∫∑c b·∫±ng 10.
                </p>
                <div id="sentences-output" class="space-y-2 mt-4 text-gray-700">
                    <p id="sentences-placeholder">Nh·∫•n 'T·∫°o' ƒë·ªÉ nh·∫≠n c√°c c√¢u v√≠ d·ª•.</p>
                </div>
            </div>

            <div id="api-unsupported-warning" class="bg-red-100 p-4 rounded-2xl text-red-700 hidden" role="alert">
                <p class="font-bold">C·∫£nh b√°o!</p>
                <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API. T√≠nh nƒÉng nghe m·∫´u v√† luy·ªán n√≥i s·∫Ω b·ªã h·∫°n ch·∫ø ho·∫∑c kh√¥ng ho·∫°t ƒë·ªông.</p>
            </div>
        </div>

        <!-- D√≤ng ghi c√¥ng -->
        <div class="w-full">
            <p class="text-sm text-center text-gray-500 mt-8">Created by th·∫ßy Hi·∫øu</p>
        </div>

    </div>

    <!-- Toast message -->
    <div id="toast-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-xl shadow-lg opacity-0 transition-opacity duration-300">
        <!-- Toast message content -->
    </div>

    <script>
        // ============== C√°c bi·∫øn v√† h·∫±ng s·ªë global ==============
        const wordInput = document.getElementById('word-input');
        const addWordsBtn = document.getElementById('add-words-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const wordList = document.getElementById('word-list');
        const selectedWordDisplay = document.getElementById('selected-word-display');
        const ipaDisplay = document.getElementById('ipa-display');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const resultsArea = document.getElementById('results-area');
        const userTranscriptSpan = document.getElementById('user-transcript');
        const scoreDisplay = document.getElementById('score-display');
        const feedbackMessageDiv = document.getElementById('feedback-message');
        const apiUnsupportedWarning = document.getElementById('api-unsupported-warning');
        const feedbackList = document.getElementById('feedback-list');

        // C√°c ph·∫ßn t·ª≠ m·ªõi cho t√≠nh nƒÉng t·∫°o c√¢u v√≠ d·ª•
        const exampleSentencesArea = document.getElementById('example-sentences-area');
        const numSentencesInput = document.getElementById('num-sentences');
        const generateSentencesBtn = document.getElementById('generate-sentences-btn');
        const sentencesOutput = document.getElementById('sentences-output');
        const sentenceWarning = document.getElementById('sentence-warning'); // New element for warning

        let selectedWord = '';
        let wordDataset = [];
        
        // D·ªØ li·ªáu IPA c·ª©ng cho m·ªôt s·ªë t·ª´ ph·ªï bi·∫øn
        const ipaData = {
            'hello': '/h…ôÀàlo ä/',
            'world': '/w…úÀêld/',
            'apple': '/Àà√¶p…ôl/',
            'banana': '/b…ôÀàn√¶n…ô/',
            'beautiful': '/ÀàbjuÀêt…ôf…ôl/',
            'pronunciation': '/pr…ôÀån ånsiÀàe…™ É…ôn/',
            'thank you': '/ÀàŒ∏√¶≈ãk juÀê/',
            'welcome': '/Ààw…õlk…ôm/',
            'walk': '/w…îÀêk/',
            'strength': '/str…õ≈ãŒ∏/'
        };
        
        // Ki·ªÉm tra h·ªó tr·ª£ Web Speech API
        const isSpeechSynthesisSupported = 'speechSynthesis' in window;
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window;

        // API Speech Recognition
        let recognition = null;
        if (isSpeechRecognitionSupported) {
            recognition = new webkitSpeechRecognition();
            // ƒê·∫£m b·∫£o ng√¥n ng·ªØ lu√¥n l√† ti·∫øng Anh
            recognition.lang = 'en-US'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                showToast("ƒêang l·∫Øng nghe... H√£y n√≥i ngay b√¢y gi·ªù.", 5000);
                recordBtn.textContent = 'ƒêang ghi √¢m...';
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = true;
            };

            recognition.onend = () => {
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const convertedTranscript = convertDigitsToWords(transcript);
                
                // L·∫•y t·ª´ ƒë√≠ch ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω (s·ªë -> ch·ªØ) ƒë·ªÉ so s√°nh
                let targetToCompare = selectedWord;
                if (!isNaN(selectedWord) && isFinite(selectedWord)) {
                    targetToCompare = convertNumberToWords(parseInt(selectedWord));
                }

                const result = scorePronunciation(targetToCompare, convertedTranscript);
                const feedback = analyzePronunciation(targetToCompare, convertedTranscript);
                updateResultsUI(convertedTranscript, result, feedback);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                let errorMessage = 'ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh ghi √¢m.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Vui l√≤ng cho ph√©p truy c·∫≠p micro ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                showToast(errorMessage, 5000);
                recordBtn.textContent = 'üéôÔ∏è Luy·ªán n√≥i';
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                recordBtn.disabled = false;
            };
        }

        // H√†m chuy·ªÉn ƒë·ªïi s·ªë th√†nh ch·ªØ c√°i
        function convertNumberToWords(num) {
            if (num === 0) return 'zero';
            if (num > 999999999) return num.toString(); // Gi·ªõi h·∫°n x·ª≠ l√Ω cho s·ªë l·ªõn

            const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

            function convertBelow1000(n) {
                if (n === 0) return '';
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                let result = hundred > 0 ? units[hundred] + ' hundred' : '';
                if (remainder > 0) {
                    if (result !== '') result += ' and ';
                    if (remainder < 20) {
                        result += teens[remainder - 10];
                    } else {
                        const ten = Math.floor(remainder / 10);
                        const unit = remainder % 10;
                        result += tens[ten];
                        if (unit > 0) result += '-' + units[unit];
                    }
                }
                return result;
            }

            let words = '';
            let isNegative = false;
            if (num < 0) {
                isNegative = true;
                num = Math.abs(num);
            }
            
            const millions = Math.floor(num / 1000000);
            const thousands = Math.floor((num % 1000000) / 1000);
            const hundreds = num % 1000;

            if (millions > 0) {
                words += convertBelow1000(millions) + ' million ';
            }
            if (thousands > 0) {
                words += convertBelow1000(thousands) + ' thousand ';
            }
            if (hundreds > 0) {
                words += convertBelow1000(hundreds);
            }
            
            return (isNegative ? 'negative ' : '') + words.trim();
        }

        function convertDigitsToWords(text) {
            let words = text.split(' ');
            let convertedWords = [];
            words.forEach(word => {
                const num = parseInt(word);
                if (!isNaN(num) && isFinite(word)) {
                    convertedWords.push(convertNumberToWords(num));
                } else {
                    convertedWords.push(word);
                }
            });
            return convertedWords.join(' ');
        }
        
        // ============== Logic ·ª©ng d·ª•ng ==============

        // H√†m hi·ªÉn th·ªã Toast message
        const toastMessageDiv = document.getElementById('toast-message');
        function showToast(message, duration = 3000) {
            toastMessageDiv.textContent = message;
            toastMessageDiv.classList.remove('opacity-0', 'hidden');
            toastMessageDiv.classList.add('opacity-100');
            setTimeout(() => {
                toastMessageDiv.classList.remove('opacity-100');
                toastMessageDiv.classList.add('opacity-0');
            }, duration);
            setTimeout(() => {
                if (toastMessageDiv.classList.contains('opacity-0')) {
                    toastMessageDiv.classList.add('hidden');
                }
            }, duration + 300);
        }

        // H√†m l∆∞u danh s√°ch t·ª´ v√†o localStorage
        function saveWordsToLocalStorage() {
            localStorage.setItem('speak-and-fix-words', JSON.stringify(wordDataset));
        }

        // H√†m t·∫£i danh s√°ch t·ª´ t·ª´ localStorage
        function loadWordsFromLocalStorage() {
            const storedWords = localStorage.getItem('speak-and-fix-words');
            if (storedWords) {
                try {
                    wordDataset = JSON.parse(storedWords);
                    renderWordList();
                } catch (e) {
                    console.error("Failed to parse words from localStorage:", e);
                    localStorage.removeItem('speak-and-fix-words');
                }
            }
        }

        // H√†m render danh s√°ch t·ª´
        function renderWordList() {
            wordList.innerHTML = '';
            wordDataset.forEach((word, index) => {
                const wordChip = document.createElement('div');
                wordChip.className = `flex items-center space-x-2 bg-blue-200 text-blue-800 text-sm font-semibold px-3 py-2 rounded-full cursor-pointer hover:bg-blue-300 transition-colors ${selectedWord === word ? 'ring-2 ring-blue-500' : ''}`;
                wordChip.textContent = word;
                wordChip.dataset.word = word;
                wordChip.onclick = () => selectWord(word);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-blue-800 hover:text-blue-900 leading-none';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeWord(index);
                };
                wordChip.appendChild(removeBtn);
                wordList.appendChild(wordChip);
            });
            updateButtonsState();
        }

        // H√†m l·∫•y IPA t·ª´ dictionary
        function getIPA(word) {
            return ipaData[word.toLowerCase()] || `(Kh√¥ng c√≥ IPA)`;
        }

        // H√†m ch·ªçn t·ª´
        function selectWord(word) {
            selectedWord = word;
            selectedWordDisplay.textContent = word;
            resultsArea.classList.add('hidden');
            exampleSentencesArea.classList.remove('hidden');
            renderWordList();
            updateButtonsState();
            
            // Hi·ªÉn th·ªã IPA
            const ipa = getIPA(word);
            if (ipa && ipa !== '(Kh√¥ng c√≥ IPA)') {
                ipaDisplay.textContent = ipa;
                ipaDisplay.classList.remove('hidden');
            } else {
                ipaDisplay.classList.add('hidden');
            }
            
            // Clear example sentences on word change
            sentencesOutput.innerHTML = '<p id="sentences-placeholder">Nh·∫•n \'T·∫°o\' ƒë·ªÉ nh·∫≠n c√°c c√¢u v√≠ d·ª•.</p>';
        }

        // H√†m x√≥a t·ª´
        function removeWord(index) {
            const wordToRemove = wordDataset[index];
            wordDataset.splice(index, 1);
            if (selectedWord === wordToRemove) {
                selectedWord = '';
                selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                ipaDisplay.classList.add('hidden');
                resultsArea.classList.add('hidden');
                exampleSentencesArea.classList.add('hidden');
            }
            saveWordsToLocalStorage();
            renderWordList();
        }

        // H√†m x√≥a t·∫•t c·∫£ c√°c t·ª´
        function clearAllWords() {
            wordDataset = [];
            selectedWord = '';
            saveWordsToLocalStorage();
            renderWordList();
            selectedWordDisplay.textContent = 'Ch·ªçn m·ªôt t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
            ipaDisplay.classList.add('hidden');
            resultsArea.classList.add('hidden');
            exampleSentencesArea.classList.add('hidden');
            showToast("ƒê√£ x√≥a t·∫•t c·∫£ c√°c t·ª´.", 3000);
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t
        function updateButtonsState() {
            const isWordSelected = selectedWord.length > 0;
            speakBtn.disabled = !isWordSelected || !isSpeechSynthesisSupported;
            recordBtn.disabled = !isWordSelected || !isSpeechRecognitionSupported;
            generateSentencesBtn.disabled = !isWordSelected;
            clearAllBtn.disabled = wordDataset.length === 0;

            if (!isSpeechRecognitionSupported) {
                apiUnsupportedWarning.classList.remove('hidden');
            }
        }

        // H√†m t√≠nh Levenshtein distance
        function levenshtein(a, b) {
            const an = a.toLowerCase().length;
            const bn = b.toLowerCase().length;
            const matrix = Array.from({ length: an + 1 }, () => Array(bn + 1).fill(0));

            for (let i = 0; i <= an; i++) matrix[i][0] = i;
            for (let j = 0; j <= bn; j++) matrix[0][j] = j;

            for (let i = 1; i <= an; i++) {
                for (let j = 1; j <= bn; j++) {
                    const cost = a.toLowerCase()[i - 1] === b.toLowerCase()[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }
            return matrix[an][bn];
        }

        // H√†m so s√°nh v√† ch·∫•m ƒëi·ªÉm
        function scorePronunciation(targetWord, spokenText) {
            const normalizedTarget = targetWord.toLowerCase().replace(/[^a-z]/g, '');
            const normalizedSpoken = spokenText.toLowerCase().replace(/[^a-z]/g, '');

            const distance = levenshtein(normalizedTarget, normalizedSpoken);
            const maxLength = Math.max(normalizedTarget.length, normalizedSpoken.length);
            let score = maxLength > 0 ? Math.round((1 - distance / maxLength) * 100) : 100;
            
            if (distance > normalizedTarget.length * 0.75) {
                score -= 10;
            }
            score = Math.max(0, score);

            return { score };
        }
        
        // H√†m ph√¢n t√≠ch chi ti·∫øt ph√°t √¢m
        function analyzePronunciation(targetWord, spokenText) {
            const feedback = [];
            const target = targetWord.toLowerCase();
            const spoken = spokenText.toLowerCase();

            if (target.includes('th')) {
                if (!spoken.includes('th') && spoken.includes('t') || spoken.includes('d')) {
                    feedback.push("C·∫ßn ch√∫ √Ω √¢m 'th'. Thay v√¨ ph√°t √¢m nh∆∞ 't' ho·∫∑c 'd', h√£y ƒë·∫©y l∆∞·ª°i ra gi·ªØa hai h√†m rƒÉng.");
                } else if (!spoken.includes('th')) {
                    feedback.push("B·∫°n ƒë√£ b·ªè qua √¢m 'th' trong t·ª´. H√£y th·ª≠ luy·ªán t·∫≠p √¢m n√†y.");
                }
            }
            if (target.includes('l')) {
                if (target.endsWith('l') && spoken.length < target.length) {
                    if (target === 'walk' && spoken === 'wok') {
                        feedback.push("Trong t·ª´ 'walk', √¢m 'l' l√† √¢m c√¢m (silent). B·∫°n ƒë√£ ph√°t √¢m ƒë√∫ng.");
                    } else {
                        feedback.push("H√£y ƒë·∫£m b·∫£o b·∫°n ph√°t √¢m √¢m 'l' ·ªü cu·ªëi t·ª´ m·ªôt c√°ch r√µ r√†ng, n·∫øu kh√¥ng ph·∫£i l√† √¢m c√¢m.");
                    }
                }
            }
            
            const targetWords = targetWord.toLowerCase().split(' ');
            const spokenWords = spokenText.toLowerCase().split(' ');

            for (let i = 0; i < targetWords.length; i++) {
                const targetW = targetWords[i];
                const spokenW = spokenWords[i];
                if (!spokenW) continue;

                if (targetW !== spokenW) {
                    const distance = levenshtein(targetW, spokenW);
                    const maxLength = Math.max(targetW.length, spokenW.length);
                    if (distance / maxLength > 0.5) {
                        feedback.push(`C√≥ v·∫ª b·∫°n ƒë√£ ph√°t √¢m sai t·ª´ "${targetW}". H√£y c·ªë g·∫Øng nghe k·ªπ v√† l·∫∑p l·∫°i.`);
                    }
                }
            }

            if (spokenWords.length > targetWords.length) {
                feedback.push("B·∫°n ƒë√£ th√™m m·ªôt v√†i t·ª´ kh√¥ng c√≥ trong t·ª´ g·ªëc. H√£y ch√∫ √Ω h∆°n ƒë·∫øn nh·ªØng t·ª´ c·∫ßn n√≥i.");
            }
            
            if (feedback.length === 0) {
                feedback.push("Ph√°t √¢m c·ªßa b·∫°n r·∫•t t·ªët! Kh√¥ng c√≥ l·ªói r√µ r√†ng n√†o ƒë∆∞·ª£c ph√°t hi·ªán.");
            }

            return feedback;
        }

        // H√†m c·∫≠p nh·∫≠t giao di·ªán k·∫øt qu·∫£
        function updateResultsUI(transcript, result, feedback) {
            resultsArea.classList.remove('hidden');
            userTranscriptSpan.textContent = transcript;
            feedbackList.innerHTML = '';

            let message = '';
            let color = '';
            if (result.score >= 85) {
                message = 'Ph√°t √¢m t·ªët! C√°c t·ª´ b·∫°n n√≥i kh·ªõp g·∫ßn nh∆∞ ho√†n to√†n.';
                color = 'bg-green-500';
            } else if (result.score >= 70) {
                message = `Ph√°t √¢m t·∫°m ·ªïn. C·∫ßn luy·ªán t·∫≠p th√™m m·ªôt ch√∫t nh√©.`;
                color = 'bg-yellow-500';
            } else {
                message = `C·∫ßn luy·ªán th√™m. C·ªë g·∫Øng ph√°t √¢m r√µ r√†ng h∆°n.`;
                color = 'bg-red-500';
            }

            scoreDisplay.textContent = result.score;
            scoreDisplay.className = `w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white shadow-md ${color}`;
            feedbackMessageDiv.innerHTML = message;
            
            // C·∫≠p nh·∫≠t feedback chi ti·∫øt
            let hasErrors = false;
            feedback.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                if (item.includes("C·∫ßn ch√∫ √Ω") || item.includes("b·ªè qua") || item.includes("sai t·ª´") || item.includes("th√™m m·ªôt v√†i t·ª´")) {
                    hasErrors = true;
                }
                feedbackList.appendChild(li);
            });

            if (hasErrors) {
                feedbackList.classList.add('has-errors');
            } else {
                feedbackList.classList.remove('has-errors');
            }
        }

        // H√†m g·ªçi API Gemini ƒë·ªÉ t·∫°o c√¢u v√≠ d·ª•
        async function generateExampleSentences() {
            const numSentences = parseInt(numSentencesInput.value);
            const word = selectedWord;

            // Ki·ªÉm tra gi·ªõi h·∫°n s·ªë c√¢u
            if (numSentences > 10) {
                sentenceWarning.classList.remove('hidden');
                showToast("S·ªë l∆∞·ª£ng c√¢u kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n 10.");
                return;
            } else {
                sentenceWarning.classList.add('hidden');
            }

            if (!word || numSentences < 1) {
                showToast("Vui l√≤ng ch·ªçn m·ªôt t·ª´ v√† nh·∫≠p s·ªë l∆∞·ª£ng c√¢u h·ª£p l·ªá.");
                return;
            }

            sentencesOutput.innerHTML = '<p class="text-gray-500 italic">ƒêang t·∫°o c√¢u v√≠ d·ª•...</p>';
            generateSentencesBtn.disabled = true;

            try {
                const prompt = `Generate ${numSentences} simple English example sentences for the word "${word}". The sentences should be grammatically correct and use the word in different contexts if possible. Provide only the sentences, one per line, with a number at the beginning of each line (e.g., "1. Sentence one.").`;

                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const text = result.candidates[0].content.parts[0].text;
                    const sentences = text.split('\n').filter(s => s.trim().length > 0);
                    
                    sentencesOutput.innerHTML = '';
                    sentences.forEach(sentence => {
                        const p = document.createElement('p');
                        p.textContent = sentence.trim();
                        sentencesOutput.appendChild(p);
                    });

                } else {
                    sentencesOutput.innerHTML = '<p class="text-red-500 italic">Kh√¥ng th·ªÉ t·∫°o c√¢u v√≠ d·ª•. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
                    console.error("Unexpected API response structure:", result);
                }

            } catch (error) {
                sentencesOutput.innerHTML = '<p class="text-red-500 italic">ƒê√£ x·∫£y ra l·ªói khi t·∫°o c√¢u v√≠ d·ª•. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                console.error("Error generating sentences:", error);
            } finally {
                generateSentencesBtn.disabled = false;
            }
        }

        // ============== C√°c s·ª± ki·ªán ==============

        // N√∫t Th√™m t·ª´
        addWordsBtn.addEventListener('click', () => {
            const newWords = wordInput.value
                .split(/,|\n/)
                .map(phrase => {
                    let correctedPhrase = phrase.trim();
                    if (correctedPhrase.length === 0) return null;

                    // Chuy·ªÉn " i " th√†nh " I " (c√≥ kho·∫£ng tr·∫Øng)
                    correctedPhrase = correctedPhrase.replace(/(\s)i(\s)/g, '$1I$2');

                    // Chuy·ªÉn "i " th√†nh "I " ·ªü ƒë·∫ßu c√¢u
                    if (correctedPhrase.startsWith('i ')) {
                        correctedPhrase = 'I' + correctedPhrase.substring(1);
                    }
                    
                    // Chuy·ªÉn "i" th√†nh "I" n·∫øu n√≥ l√† m·ªôt t·ª´ ƒë·ªôc l·∫≠p
                    if (correctedPhrase.toLowerCase() === 'i') {
                        correctedPhrase = 'I';
                    }

                    return correctedPhrase;
                })
                .filter(phrase => phrase && phrase.length > 0);
            
            if (newWords.length > 0) {
                wordDataset = [...new Set([...wordDataset, ...newWords])];
                wordInput.value = '';
                saveWordsToLocalStorage();
                renderWordList();
                showToast(`ƒê√£ th√™m ${newWords.length} t·ª´ v√†o danh s√°ch.`, 3000);
            } else {
                showToast("Vui l√≤ng nh·∫≠p t·ª´ h·ª£p l·ªá.", 3000);
            }
        });

        // N√∫t X√≥a t·∫•t c·∫£
        clearAllBtn.addEventListener('click', clearAllWords);

        // N√∫t Nghe m·∫´u
        speakBtn.addEventListener('click', () => {
            if (isSpeechSynthesisSupported) {
                // S·ª≠ d·ª•ng t·ª´ g·ªëc (v√≠ d·ª•: "123") ƒë·ªÉ ƒë·ªçc
                const utterance = new SpeechSynthesisUtterance(selectedWord);
                
                // L·∫•y danh s√°ch gi·ªçng n√≥i v√† t√¨m gi·ªçng ti·∫øng Anh (en-US)
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(voice => voice.lang.startsWith('en-'));
                
                // N·∫øu t√¨m th·∫•y, ƒë·∫∑t gi·ªçng n√≥i l√† ti·∫øng Anh
                if (englishVoice) {
                    utterance.voice = englishVoice;
                } else {
                    console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng n√≥i ti·∫øng Anh. S·ª≠ d·ª•ng gi·ªçng m·∫∑c ƒë·ªãnh.");
                }
                
                // B·∫Øt ƒë·∫ßu ƒë·ªçc
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // N√∫t Luy·ªán n√≥i
        recordBtn.addEventListener('click', () => {
            if (isSpeechRecognitionSupported) {
                recognition.start();
            } else {
                showToast("T√≠nh nƒÉng n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.", 3000);
            }
        });

        // N√∫t T·∫°o c√¢u v√≠ d·ª•
        generateSentencesBtn.addEventListener('click', generateExampleSentences);

        // Ph√≠m t·∫Øt b√†n ph√≠m
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !recordBtn.disabled) {
                e.preventDefault();
                recordBtn.click();
            } else if (e.code === 'Enter' && !speakBtn.disabled && document.activeElement !== wordInput) {
                e.preventDefault();
                speakBtn.click();
            }
        });

        // T·∫£i d·ªØ li·ªáu khi trang web ƒë∆∞·ª£c t·∫£i
        window.onload = () => {
            loadWordsFromLocalStorage();
        };
    </script>
</body>
</html>
